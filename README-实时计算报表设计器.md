# 实时计算报表设计器使用说明

## 功能概述

全新的实时计算报表设计器，支持：
- 🔄 **实时计算**：字段表达式自动计算，数据实时更新
- 🎯 **拖拽设计**：直观的拖拽操作，所见即所得
- 📊 **字段表达式**：支持条件判断、数学运算、字符串处理
- 🏥 **医疗专用**：内置医疗行业数据源和场景

## 核心功能特性

### 1. 数据源配置
- **患者就诊信息**：包含患者姓名、就诊时间、科室、医生、诊断、年龄
- **用户管理**：用户ID、用户名、邮箱、角色、状态、薪资
- **部门统计**：部门ID、部门名称、负责人、员工数、预算

### 2. 字段类型支持
- 🔤 **字符串 (string)**：姓名、科室、诊断等文本信息
- 🔢 **数字 (number)**：年龄、薪资、员工数等数值信息
- 📅 **日期时间 (datetime)**：就诊时间、创建日期等时间信息
- 📝 **文本 (text)**：长文本描述信息
- ✅ **布尔 (boolean)**：是/否判断

### 3. 表达式系统

#### 基础表达式
```javascript
// 条件表达式
age > 60 ? '老年' : '非老年'
age >= 18 && age <= 60 ? '成年' : '其他'

// 数学运算
age * 2
salary * 12  // 年薪计算

// 字符串拼接
patient_name + '先生'
department + '科室'
```

#### 高级表达式
```javascript
// 多重条件
age < 18 ? '未成年' : (age < 60 ? '成年' : '老年')

// 数值范围判断
salary > 10000 ? '高薪' : (salary > 5000 ? '中等' : '低薪')

// 科室分类
department === '内科' || department === '外科' ? '临床科室' : '辅助科室'
```

## 使用流程

### 第一步：选择数据源
1. 在右侧面板选择数据源（患者就诊信息/用户管理/部门统计）
2. 系统自动加载字段列表和数据预览
3. 查看可用字段类型和示例数据

### 第二步：使用原始字段
1. 在"原始字段"列表中找到需要的字段
2. 拖拽字段到中央表格的列标题上
3. 字段成功绑定后，列标题显示蓝色并显示字段名称
4. 数据自动填充到表格中

### 第三步：创建计算字段
1. 在"创建计算字段"区域填写：
   - **字段名称**：如"年龄分组"、"薪资等级"
   - **计算表达式**：如`age > 60 ? '老年' : '非老年'`
   - **字段类型**：选择返回值类型
2. 点击"创建字段"按钮
3. 新字段出现在"计算字段"列表中

### 第四步：使用计算字段
1. 拖拽计算字段到表格列标题
2. 系统实时计算表达式结果
3. 计算结果立即显示在表格中

## 实际应用场景

### 场景1：患者年龄分组分析
```javascript
// 字段名称：年龄分组
// 表达式：
age < 18 ? '儿童' : (age < 60 ? '成人' : '老年')

// 结果示例：
// 张三(45岁) → 成人
// 王五(8岁) → 儿童  
// 孙七(67岁) → 老年
```

### 场景2：薪资等级分类
```javascript
// 字段名称：薪资等级
// 表达式：
salary > 12000 ? '高级' : (salary > 8000 ? '中级' : '初级')

// 结果示例：
// admin(15000) → 高级
// doctor1(12000) → 高级
// nurse1(8000) → 中级
```

### 场景3：科室类型判断
```javascript
// 字段名称：科室分类
// 表达式：
department === '内科' || department === '外科' || department === '儿科' ? '临床科室' : '医技科室'
```

### 场景4：就诊时段分析
```javascript
// 字段名称：就诊时段
// 表达式：
visit_date.includes('09:') || visit_date.includes('10:') ? '上午' : '下午'
```

## 操作技巧

### 1. 字段管理
- **移除绑定**：点击列标题右侧的 ❌ 按钮
- **清空表格**：点击顶部"清空表格"按钮
- **编辑计算字段**：点击字段右侧的编辑图标

### 2. 表达式编写
- **字段引用**：直接使用字段名称，如 `age`、`patient_name`
- **字符串值**：使用单引号，如 `'老年'`、`'高薪'`
- **数值比较**：支持 `>`、`<`、`>=`、`<=`、`===`、`!==`
- **逻辑运算**：支持 `&&`（且）、`||`（或）、`!`（非）

### 3. 调试技巧
- 先在简单数据上测试表达式
- 使用表达式帮助查看示例
- 如果计算出错，单元格会显示"Error: ..."

## 数据类型转换

```javascript
// 数字转字符串
age + '岁'

// 条件返回不同类型
age > 60 ? true : false  // 返回布尔值
age > 60 ? 1 : 0        // 返回数字
age > 60 ? '是' : '否'   // 返回字符串
```

## 常见问题

### Q: 为什么我的表达式不生效？
A: 检查字段名称是否正确，确保表达式语法正确，字符串要用引号

### Q: 如何引用其他计算字段？
A: 当前版本暂不支持引用其他计算字段，请在一个表达式中完成所有计算

### Q: 表达式可以多复杂？
A: 支持嵌套条件、多重判断，但建议保持表达式简洁易读

### Q: 数据更新后计算字段会自动重新计算吗？
A: 是的，所有计算字段都会实时重新计算

## 技术特性

- ✅ **响应式计算**：数据变化时自动重新计算
- ✅ **类型安全**：支持多种数据类型
- ✅ **错误处理**：表达式错误时显示错误信息
- ✅ **实时预览**：拖拽即可查看效果
- ✅ **可视化设计**：所见即所得的界面

这个实时计算报表设计器为医疗行业提供了强大而灵活的数据分析和报表生成能力，支持复杂的业务逻辑计算，让数据分析变得简单直观。 
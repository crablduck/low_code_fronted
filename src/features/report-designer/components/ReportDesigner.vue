/*
 * @Author: Mr.Crab
 * @Date: 2025-01-14 10:00:00
 * @LastEditors: Mr.Crab
 * @LastEditTime: 2025-01-14 10:00:00
 * @FilePath: /workflow-system/src/components/ReportDesigner.vue
 * @Description: ÁúüÊ≠£ExcelÈ£éÊ†ºÁöÑÊä•Ë°®ËÆæËÆ°Âô®
 */
<template>
  <div class="report-designer">
    <!-- È°∂ÈÉ®Â∑•ÂÖ∑Ê†è -->
    <div class="designer-header">
      <div class="header-left">
          <el-button-group>
          <el-button size="small" @click="handleSave" :loading="saving" class="excel-btn">
            <el-icon><DocumentCopy /></el-icon>
            ‰øùÂ≠ò
          </el-button>
          <el-button size="small" @click="updateRender" :loading="rendering" class="excel-btn" type="success">
            <el-icon><Refresh /></el-icon>
            Êõ¥Êñ∞Ê∏≤Êüì
          </el-button>
          <el-button size="small" @click="clearAll" class="excel-btn">
            <el-icon><Delete /></el-icon>
            Ê∏ÖÁ©∫Ë°®Ê†º
            </el-button>
          </el-button-group>
        
        <el-divider direction="vertical" />
        
        <span class="report-title">{{ reportData.name || 'ExcelÊä•Ë°®ËÆæËÆ°Âô®' }}</span>
        </div>

      <div class="header-right">
        <el-button size="small" @click="toggleRightPanel" class="excel-btn" :type="rightPanelVisible ? 'primary' : ''">
          <el-icon><Operation /></el-icon>
          {{ rightPanelVisible ? 'ÈöêËóèÈù¢Êùø' : 'ÊòæÁ§∫Èù¢Êùø' }}
        </el-button>
        <!-- ÂÖ®Â±èÊ®°ÂºèÊó∂ÊòæÁ§∫ËøîÂõû‰∏ä‰∏ÄÈ°µÊåâÈíÆÔºåÂê¶ÂàôÊòæÁ§∫ËøîÂõûÊä•Ë°®ÊåâÈíÆ -->
        <el-button v-if="route.meta?.layout === 'fullscreen'" size="small" @click="router.back()" class="excel-btn">
          <el-icon><ArrowLeft /></el-icon>
          ËøîÂõû‰∏ä‰∏ÄÈ°µ
        </el-button>
        <el-button v-else size="small" @click="$emit('back')" class="excel-btn">
          <el-icon><ArrowLeft /></el-icon>
          ËøîÂõûÊä•Ë°®
        </el-button>
      </div>
    </div>

    <!-- ExcelÂ∑•ÂÖ∑Ê†èÁªÑ -->
    <div class="excel-toolbars">
      <!-- ‰∏ªÂ∑•ÂÖ∑Ê†è -->
      <div class="excel-toolbar main-toolbar">
        <div class="toolbar-group">
          <!-- Êñá‰ª∂Êìç‰Ωú -->
          <div class="toolbar-section">
            <el-button size="small" class="toolbar-btn" title="Êñ∞Âª∫">
              <el-icon><Plus /></el-icon>
            </el-button>
            <el-button size="small" class="toolbar-btn" title="ÊâìÂºÄ">
              <el-icon><FolderOpened /></el-icon>
            </el-button>
            <el-button size="small" class="toolbar-btn" title="‰øùÂ≠ò" @click="handleSave">
              <el-icon><DocumentCopy /></el-icon>
            </el-button>
            <el-button size="small" class="toolbar-btn" title="ÊâìÂç∞">
              <el-icon><Printer /></el-icon>
            </el-button>
          </div>

          <div class="toolbar-divider"></div>

          <!-- Êí§ÈîÄÈáçÂÅö -->
          <div class="toolbar-section">
            <el-button size="small" class="toolbar-btn" title="Êí§ÈîÄ">
              <el-icon><RefreshLeft /></el-icon>
            </el-button>
            <el-button size="small" class="toolbar-btn" title="ÈáçÂÅö">
              <el-icon><RefreshRight /></el-icon>
            </el-button>
          </div>

          <div class="toolbar-divider"></div>

          <!-- üß© ÁªÑ‰ª∂ÊèíÂÖ•Âå∫Âüü -->
          <div class="toolbar-section components-toolbar">
            <label class="section-label">ÊèíÂÖ•ÁªÑ‰ª∂:</label>
            <div class="toolbar-components">
              <div 
                v-for="component in availableComponents" 
                :key="component.type"
                class="toolbar-component-item"
                draggable="true"
                @dragstart="handleComponentDragStart($event, component)"
                @click="insertComponentAtCursor(component)"
                :title="`ÊèíÂÖ• ${component.name}`"
              >
                <el-icon>
                  <component :is="component.icon" />
                </el-icon>
                <span>{{ component.name }}</span>
              </div>
            </div>
          </div>

          <div class="toolbar-divider"></div>

          <!-- Â≠ó‰ΩìÂíåÊ†ºÂºè -->
          <div class="toolbar-section">
            <el-select v-model="currentFont" size="small" style="width: 120px" class="excel-select">
            <el-option label="ÂæÆËΩØÈõÖÈªë" value="Microsoft YaHei" />
            <el-option label="ÂÆã‰Ωì" value="SimSun" />
            <el-option label="Arial" value="Arial" />
              <el-option label="Calibri" value="Calibri" />
          </el-select>
            
            <el-select v-model="fontSize" size="small" style="width: 70px; margin-left: 8px" class="excel-select">
              <el-option v-for="size in fontSizes" :key="size" :label="size" :value="size" />
          </el-select>

            <el-button-group class="format-buttons" style="margin-left: 8px">
              <el-button size="small" :class="{ 'is-active': cellFormat.bold }" @click="toggleBold" class="format-btn">
                <strong>B</strong>
            </el-button>
              <el-button size="small" :class="{ 'is-active': cellFormat.italic }" @click="toggleItalic" class="format-btn">
                <em>I</em>
              </el-button>
              <el-button size="small" :class="{ 'is-active': cellFormat.underline }" @click="toggleUnderline" class="format-btn">
                <u>U</u>
            </el-button>
          </el-button-group>
        </div>

          <div class="toolbar-divider"></div>

          <!-- È¢úËâ≤Â∑•ÂÖ∑ -->
          <div class="toolbar-section">
            <el-color-picker v-model="cellFormat.color" size="small" class="color-picker" />
            <el-color-picker v-model="cellFormat.backgroundColor" size="small" class="color-picker" style="margin-left: 8px" />
        </div>

          <div class="toolbar-divider"></div>

          <!-- ËæπÊ°ÜÂíåÂØπÈΩê -->
          <div class="toolbar-section">
            <el-button-group class="border-buttons">
              <el-button size="small" title="ÊâÄÊúâËæπÊ°Ü" @click="setBorderStyle('all')" class="border-btn">
                <el-icon><Grid /></el-icon>
            </el-button>
              <el-button size="small" title="Â§ñËæπÊ°Ü" @click="setBorderStyle('outer')" class="border-btn">
                ‚äû
              </el-button>
              <el-button size="small" title="Êó†ËæπÊ°Ü" @click="setBorderStyle('none')" class="border-btn">
                ‚ñ°
              </el-button>
            </el-button-group>

            <el-button-group class="align-buttons" style="margin-left: 8px">
              <el-button size="small" title="Â∑¶ÂØπÈΩê" class="align-btn" @click="setAlignment('left')">
                <el-icon><Back /></el-icon>
              </el-button>
              <el-button size="small" title="Â±Ö‰∏≠ÂØπÈΩê" class="align-btn" @click="setAlignment('center')">
                <el-icon><Position /></el-icon>
              </el-button>
              <el-button size="small" title="Âè≥ÂØπÈΩê" class="align-btn" @click="setAlignment('right')">
                <el-icon><Right /></el-icon>
            </el-button>
          </el-button-group>
        </div>

          <div class="toolbar-divider"></div>

          <!-- ÂêàÂπ∂ÂçïÂÖÉÊ†º -->
          <div class="toolbar-section">
            <el-button size="small" class="toolbar-btn" @click="mergeSelectedCells" :disabled="!canMerge" title="ÂêàÂπ∂ÂçïÂÖÉÊ†º">
              <el-icon><CopyDocument /></el-icon>
            </el-button>
            <el-button size="small" class="toolbar-btn" @click="splitSelectedCells" :disabled="!canSplit" title="ÊãÜÂàÜÂçïÂÖÉÊ†º">
              <el-icon><DocumentRemove /></el-icon>
            </el-button>
          </div>
          
          <div class="toolbar-divider"></div>
          
          <!-- üéØ ÈÄâÊã©ËåÉÂõ¥Êìç‰Ωú -->
          <div class="toolbar-section">
            <el-button size="small" @click="selectAll" title="ÂÖ®ÈÄâ" class="toolbar-btn">
              <el-icon><Select /></el-icon>
              ÂÖ®ÈÄâ
            </el-button>
            <el-button size="small" @click="clearSelection" title="Ê∏ÖÈô§ÈÄâÊã©" class="toolbar-btn">
              <el-icon><Close /></el-icon>
              Ê∏ÖÈô§
            </el-button>
          </div>

          <div class="toolbar-divider"></div>

          <!-- Êõ¥Êñ∞Ê∏≤Êüì -->
          <div class="toolbar-section">
            <el-button size="small" @click="updateRender" :loading="rendering" type="success" class="render-btn">
              <el-icon><Refresh /></el-icon>
              Êõ¥Êñ∞Ê∏≤Êüì
            </el-button>
          </div>

          <!-- Â∑•ÂÖ∑Ê†è-ÂØºÂÖ•ÂØºÂá∫ -->
          <div class="toolbar-group">
            <el-button-group>
              <el-button size="small" @click="showInsertTableDialog">
                <el-icon><Grid /></el-icon>
                ÊèíÂÖ•Ë°®Ê†º
              </el-button>
              <el-button size="small" @click="showExportDialog">
                <el-icon><Download /></el-icon>
                ÂØºÂá∫
              </el-button>
            </el-button-group>
          </div>
        </div>
      </div>

      <!-- ÂÖ¨ÂºèÊ†è -->
      <div class="formula-bar">
        <div class="name-box">
          <input v-model="selectedCell.ref" readonly class="name-input" />
        </div>
        <div class="fx-label">fx</div>
        <div class="formula-input-container">
          <input 
            v-model="cellFormula" 
            class="formula-input" 
            placeholder="Âú®Ê≠§ËæìÂÖ•ÂÖ¨ÂºèÊàñÊãñÂÖ•Â≠óÊÆµÔºåÂ¶Ç: ${visit_count} * 10"
            @keyup.enter="applyFormula"
            @drop="handleFormulaDrop"
            @dragover.prevent
            @dragenter.prevent
            :class="{ 'formula-drag-over': isFormulaDragOver }"
          />
          <el-button 
          size="small"
            type="primary" 
            @click="applyFormula"
            class="apply-formula-btn"
          >
            <el-icon><Check /></el-icon>
            Â∫îÁî®
          </el-button>
        </div>
        
        <!-- ÂÖ¨ÂºèÂ∏ÆÂä©ÊèêÁ§∫ -->
        <div class="formula-help" v-if="cellFormula">
          <span class="formula-preview">
            È¢ÑËßà: {{ getFormulaPreview() }}
          </span>
        </div>
      </div>
    </div>

    <!-- ‰∏ªÂÜÖÂÆπÂå∫Âüü -->
    <div class="designer-body">
      <!-- ‰∏≠Â§ÆExcelË°®Ê†ºÂå∫Âüü -->
      <div class="table-container" :style="{ 'margin-right': rightPanelVisible ? '300px' : '0' }">
        <!-- ExcelË°®Ê†º -->
        <div class="excel-table-wrapper">
          <!-- ÂàóÊ†áÈ¢ò -->
        <div class="column-headers">
            <div class="corner-cell"></div>
            <div v-for="col in allColumns" :key="col" class="column-header" 
                 :class="{ 
                   'selected': selectedCell.col === col, 
                   'has-field': getColumnField(col),
                   'drop-active': isDragOverColumn === col
                 }"
                 :style="{ width: (columnWidths[col] || defaultColumnWidth) + 'px' }"
                 @click="selectColumnHeader(col)">
              <div v-if="getColumnField(col)" class="column-field">
                <span class="field-name" :title="getColumnField(col).label">{{ getColumnField(col).label }}</span>
                <el-button size="small" text @click.stop="removeColumnField(col)">
                  <el-icon><Close /></el-icon>
                </el-button>
              </div>
              <div v-else class="drop-zone" 
                   @drop="handleColumnDrop($event, col)"
                   @dragover="handleDragOver($event, col)"
                   @dragenter="handleDragEnter($event, col)"
                   @dragleave="handleDragLeave($event, col)">
            {{ col }}
              </div>
              <!-- ÂàóÂÆΩË∞ÉÊï¥ÊâãÊüÑ -->
              <div 
                class="resize-handle resize-handle-col"
                @mousedown="startResize($event, 'column', col)"
                @dblclick="autoFitColumn(col)"
                title="ÊãñÊãΩË∞ÉÊï¥ÂàóÂÆΩÔºåÂèåÂáªËá™ÈÄÇÂ∫î"
              ></div>
          </div>
        </div>

        <!-- Ë°®Ê†º‰∏ª‰Ωì -->
          <div class="spreadsheet-body">
            <!-- Ë°åÊ†áÈ¢ò -->
            <div class="row-headers" ref="rowHeadersRef">
              <div v-for="row in allRows" :key="row" class="row-header"
                   :class="{ 'selected': selectedCell.row === row }">
              {{ row }}
            </div>
          </div>

            <!-- ÂçïÂÖÉÊ†ºË°®Ê†º -->
            <div class="cells-area" ref="cellsAreaRef" @scroll="handleScroll">
              <table class="excel-table">
              <tbody>
                  <tr v-for="rowIndex in allRows" :key="rowIndex">
                    <td v-for="col in allColumns" :key="col" 
                        :class="getCellClass(rowIndex, col)"
                        @click="selectCell(rowIndex, col, $event)"
                        @mousedown="startCellSelection($event, rowIndex, col)"
                        @mouseenter="handleCellMouseEnter($event, rowIndex, col)"
                        @mouseup="endCellSelection"
                        @dblclick="editCell(rowIndex, col)"
                        @contextmenu.prevent="handleCellRightClick($event, rowIndex, col)"
                        @dragover.prevent="handleCellDragOver($event, rowIndex, col)"
                        @drop="handleCellDrop($event, rowIndex, col)"
                        @dragenter="handleCellDragEnter($event, rowIndex, col)"
                        @dragleave="handleCellDragLeave($event, rowIndex, col)"
                        :style="getCellStyle(rowIndex, col)">
                      <input 
                        v-if="isEditing(rowIndex, col)"
                        class="cell-input"
                        v-model="editingValue"
                        @blur="finishEdit"
                        @keyup.enter="finishEdit"
                        @keyup.esc="cancelEdit"
                        ref="cellInputRef"
                      />
                      <div v-else class="cell-content" 
                           :class="{ 'drop-ready': isCellDropReady(rowIndex, col) }">
                        {{ getCellValue(rowIndex, col) }}
                        <div v-if="isCellDropReady(rowIndex, col)" class="drop-hint">
                          ÊãñÊãΩÂ≠óÊÆµÂà∞Ê≠§
                        </div>
                    </div>
                  </td>
                </tr>
              </tbody>
            </table>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- üî• ÁªùÂØπÂÆö‰ΩçÁöÑÂè≥‰æßÊï∞ÊçÆÊ∫êÈù¢Êùø - 100%ÂèØËßÅÔºÅ -->
    <div class="fixed-right-panel" :class="{ 'panel-hidden': !rightPanelVisible }">
      <!-- Èù¢ÊùøÂ§¥ÈÉ® -->
      <div class="panel-header">
        <div class="panel-title">
          <el-icon><Operation /></el-icon>
          <span>Êï∞ÊçÆÊ∫êÈù¢Êùø</span>
        </div>
        <el-button size="small" text @click="toggleRightPanel" class="close-btn">
          <el-icon><Close /></el-icon>
        </el-button>
      </div>

      <!-- Èù¢ÊùøÂÜÖÂÆπ -->
      <div class="panel-content">
        <!-- Êï∞ÊçÆÊ∫êÈÄâÊã©Âô® -->
        <div class="data-source-selector">
          <h4>üìã ÈÄâÊã©Êï∞ÊçÆÊ∫ê</h4>
          <el-select 
            v-model="selectedDataSource" 
            @change="loadDataSource" 
            placeholder="ËØ∑ÈÄâÊã©Êï∞ÊçÆË°®" 
            style="width: 100%; margin-bottom: 10px;"
            size="small"
          >
            <el-option 
              v-for="ds in availableDataSources" 
              :key="ds.value" 
              :label="ds.label" 
              :value="ds.value" 
            />
          </el-select>
          
          <el-button 
            type="success" 
            @click="updateRender" 
            :loading="rendering" 
            style="width: 100%;"
            size="small"
          >
            <el-icon><Refresh /></el-icon>
            Âä†ËΩΩÊï∞ÊçÆ
          </el-button>
  </div>

        <!-- üîó ÂΩìÂâçÁªëÂÆöÁä∂ÊÄÅ -->
        <div class="binding-status" v-if="Object.keys(columnFieldMap).length > 0">
          <h4>üîó ÂΩìÂâçÁªëÂÆöÁä∂ÊÄÅ</h4>
          <div class="binding-list">
            <div v-for="(field, col) in columnFieldMap" :key="col" class="binding-item">
              <span class="col-name">{{ col }}Âàó</span>
              <span class="arrow">‚Üí</span>
              <span class="field-name">{{ field.label }}</span>
              <el-button size="small" text @click="removeColumnField(col)" class="remove-binding">
                <el-icon><Close /></el-icon>
              </el-button>
            </div>
          </div>
        </div>

        <!-- üîç Êï∞ÊçÆÈ¢ÑËßàÂíåËøáÊª§ -->
        <div class="data-preview-section" v-if="sourceData.length > 0">
          <h4>üîç Êï∞ÊçÆÈ¢ÑËßà ({{ filteredData.length }} / {{ sourceData.length }})</h4>
          
          <!-- ËøáÊª§Êéß‰ª∂ -->
          <div class="filter-controls">
            <el-input
              v-model="dataFilter"
              placeholder="ËæìÂÖ•ËøáÊª§Êù°‰ª∂ÔºàÂ¶ÇÔºöÂÜÖÁßë„ÄÅ1250Ôºâ"
              size="small"
              clearable
              @input="applyDataFilter"
              style="margin-bottom: 8px;"
            >
              <template #prefix>
                <el-icon><Search /></el-icon>
              </template>
            </el-input>
            <div class="filter-tips">
              <el-tag size="small" type="info">
                {{ filteredData.length === 1 ? '‚úÖ ÂçïÊù°Êï∞ÊçÆ - ÂèØÊãñÊãΩÂà∞ÂçïÂÖÉÊ†º' : 'üìä Â§öÊù°Êï∞ÊçÆ - ÂèØÊãñÊãΩÂà∞Ë°®Â§¥' }}
              </el-tag>
            </div>
          </div>

          <!-- Êï∞ÊçÆÈ¢ÑËßàË°®Ê†º -->
          <div class="data-preview-table">
            <table class="mini-table">
              <thead>
                <tr>
                  <th v-for="field in originalFields" :key="field.name" class="mini-th">
                    {{ field.label }}
                  </th>
                </tr>
              </thead>
              <tbody>
                <tr v-for="(row, index) in filteredData.slice(0, 5)" :key="index" class="mini-tr">
                  <td v-for="field in originalFields" :key="field.name" class="mini-td">
                    {{ row[field.name] }}
                  </td>
                </tr>
              </tbody>
            </table>
            <div v-if="filteredData.length > 5" class="more-data-hint">
              ËøòÊúâ {{ filteredData.length - 5 }} Êù°Êï∞ÊçÆ...
            </div>
          </div>
        </div>

        <!-- Â≠óÊÆµÂàóË°® -->
        <div class="fields-section" v-if="originalFields.length > 0">
          <h4>üìù ÂèØÊãñÊãΩÂ≠óÊÆµ ({{ originalFields.length }})</h4>
          <div class="fields-container">
            <div 
              v-for="field in originalFields" 
              :key="field.name"
              class="field-card"
              draggable="true"
              @dragstart="handleFieldDragStart($event, field, 'original')"
            >
              <div class="field-content">
                <div class="field-name">{{ field.label }}</div>
                <div class="field-type">{{ field.type }}</div>
              </div>
              <el-icon class="drag-handle"><Rank /></el-icon>
            </div>
          </div>
        </div>

        <!-- ÁÆÄÂçïËØ¥Êòé -->
        <div class="help-section">
          <div class="help-card">
            <h4>üéØ ‰ΩøÁî®ÊñπÊ≥ï</h4>
            <ol>
              <li>ÈÄâÊã©Êï∞ÊçÆÊ∫êË°®Ê†º</li>
              <li>ÁÇπÂáª"Âä†ËΩΩÊï∞ÊçÆ"ÊåâÈíÆ</li>
              <li>ÊãñÊãΩÂ≠óÊÆµÂà∞ExcelÂàóÊ†áÈ¢ò</li>
              <li>Êü•ÁúãÊï∞ÊçÆÁªëÂÆöÁªìÊûú</li>
            </ol>
          </div>
          
          <!-- ÂÖ¨ÂºèÂäüËÉΩËØ¥Êòé -->
          <div class="formula-help-card">
            <h4>üßÆ ÂÖ¨ÂºèËÆ°ÁÆóÂäüËÉΩ</h4>
            <div class="formula-examples">
              <p><strong>Âü∫Êú¨Áî®Ê≥ïÔºö</strong></p>
              <ul>
                <li>ÁÇπÂáªÂàóÊ†áÈ¢òËøõÂÖ•ÂàóÂÖ¨ÂºèÁºñËæëÊ®°Âºè</li>
                <li>ÊãñÊãΩÂ≠óÊÆµÂà∞ÂÖ¨ÂºèÊ†èÊèíÂÖ•Â≠óÊÆµÂºïÁî®</li>
                <li>ÊîØÊåÅÊï∞Â≠¶ËøêÁÆóÔºö+„ÄÅ-„ÄÅ*„ÄÅ/</li>
              </ul>
              
              <p><strong>ÂÖ¨ÂºèÁ§∫‰æãÔºö</strong></p>
              <div class="formula-example">
                <code>${visit_count} * 10</code>
                <span class="example-desc">Â∞ÜÂ∞±ËØä‰∫∫Êï∞‰πò‰ª•10</span>
              </div>
              <div class="formula-example">
                <code>${visit_count} > 100 ? "Â§ö" : "Â∞ë"</code>
                <span class="example-desc">Êù°‰ª∂Âà§Êñ≠</span>
              </div>
              
              <p><strong>Êìç‰ΩúÊ≠•È™§Ôºö</strong></p>
              <ol>
                <li>ÁÇπÂáªÂàóÊ†áÈ¢òÔºàÂ¶ÇCÂàóÔºâ</li>
                <li>Âú®ÂÖ¨ÂºèÊ†èËæìÂÖ•ÊàñÊãñÊãΩÂ≠óÊÆµ</li>
                <li>ÁÇπÂáª"Â∫îÁî®"ÊåâÈíÆ</li>
                <li>Êü•ÁúãÊï¥ÂàóËÆ°ÁÆóÁªìÊûú</li>
              </ol>
            </div>
          </div>
        </div>

        <!-- üöÄ ‰∏ÄÈîÆÂÆåÊàêÂÖ∏ÂûãÂú∫ÊôØ -->
        <div class="scenario-section">
          <div class="scenario-card">
            <h4>üöÄ ‰∏ÄÈîÆÂÆåÊàêÂú∫ÊôØ</h4>
            <p class="scenario-desc">Ëá™Âä®ÂÆåÊàê"ÊåâÁßëÂÆ§ÁªüËÆ°ÊØèÊúàÂ∞±ËØä‰∫∫Êï∞"Êä•Ë°®ËÆæËÆ°</p>
            <el-button 
              type="primary" 
              @click="autoCompleteScenario"
              :loading="rendering"
              style="width: 100%;"
            >
              <el-icon><Star /></el-icon>
              ‰∏ÄÈîÆÂÆåÊàêÊä•Ë°®ËÆæËÆ°
            </el-button>
          </div>
        </div>
      </div>
    </div>

    <!-- Âè≥ÈîÆËèúÂçï -->
    <el-dropdown
      ref="contextMenuRef"
      :show-timeout="0"
      :hide-timeout="0"
      trigger="contextmenu"
      :visible="contextMenu.visible"
      placement="bottom-start"
      style="position: fixed; z-index: 9999;"
      :style="{ left: contextMenu.x + 'px', top: contextMenu.y + 'px' }"
    >
      <span></span>
      <template #dropdown>
        <el-dropdown-menu>
          <!-- ÂçïÂÖÉÊ†ºËåÉÂõ¥ÈÄâÊã©Êó∂ÁöÑËèúÂçï -->
          <template v-if="selectedCells.length > 1">
            <el-dropdown-item @click="mergeCells">
              <el-icon><Grid /></el-icon>
              ÂêàÂπ∂ÂçïÂÖÉÊ†º
            </el-dropdown-item>
            <el-dropdown-item @click="clearSelection">
              <el-icon><Close /></el-icon>
              Ê∏ÖÈô§ÈÄâÊã©
            </el-dropdown-item>
            <el-dropdown-item divided @click="copySelection">
              <el-icon><CopyDocument /></el-icon>
              Â§çÂà∂
            </el-dropdown-item>
            <el-dropdown-item @click="deleteSelection">
              <el-icon><Delete /></el-icon>
              Âà†Èô§ÂÜÖÂÆπ
            </el-dropdown-item>
          </template>
          
          <!-- Âçï‰∏™ÂçïÂÖÉÊ†ºËèúÂçï -->
          <template v-else>
            <el-dropdown-item @click="editCell(selectedCell.row, selectedCell.col)">
              <el-icon><Edit /></el-icon>
              ÁºñËæëÂçïÂÖÉÊ†º
            </el-dropdown-item>
            <el-dropdown-item @click="showInsertTableDialog">
              <el-icon><Grid /></el-icon>
              ÊèíÂÖ•Ë°®Ê†º
            </el-dropdown-item>
            <el-dropdown-item divided @click="copyCell">
              <el-icon><CopyDocument /></el-icon>
              Â§çÂà∂
            </el-dropdown-item>
            <el-dropdown-item @click="pasteCell">
              <el-icon><Document /></el-icon>
              Á≤òË¥¥
            </el-dropdown-item>
            <el-dropdown-item @click="clearCell">
              <el-icon><Delete /></el-icon>
              Ê∏ÖÈô§ÂÜÖÂÆπ
            </el-dropdown-item>
          </template>
          
          <el-dropdown-item divided @click="showExportDialog">
            <el-icon><Download /></el-icon>
            ÂØºÂá∫
          </el-dropdown-item>
        </el-dropdown-menu>
      </template>
    </el-dropdown>

    <!-- Ê†ºÂºèËÆæÁΩÆÂØπËØùÊ°Ü -->
    <el-dialog v-model="formatDialog.visible" title="ÂçïÂÖÉÊ†ºÊ†ºÂºè" width="500px">
      <el-form :model="formatDialog.form" label-width="100px">
        <el-form-item label="Â≠ó‰Ωì">
          <el-select v-model="formatDialog.form.fontFamily" style="width: 100%">
            <el-option label="ÂæÆËΩØÈõÖÈªë" value="Microsoft YaHei" />
            <el-option label="ÂÆã‰Ωì" value="SimSun" />
            <el-option label="Arial" value="Arial" />
            <el-option label="Calibri" value="Calibri" />
          </el-select>
        </el-form-item>
        <el-form-item label="Â≠óÂè∑">
          <el-input-number v-model="formatDialog.form.fontSize" :min="8" :max="72" />
        </el-form-item>
        <el-form-item label="Â≠ó‰ΩìÈ¢úËâ≤">
          <el-color-picker v-model="formatDialog.form.color" />
        </el-form-item>
        <el-form-item label="ËÉåÊôØÈ¢úËâ≤">
          <el-color-picker v-model="formatDialog.form.backgroundColor" />
        </el-form-item>
        <el-form-item label="ÂØπÈΩêÊñπÂºè">
          <el-select v-model="formatDialog.form.textAlign">
            <el-option label="Â∑¶ÂØπÈΩê" value="left" />
            <el-option label="Â±Ö‰∏≠" value="center" />
            <el-option label="Âè≥ÂØπÈΩê" value="right" />
          </el-select>
        </el-form-item>
        <el-form-item>
          <el-checkbox v-model="formatDialog.form.bold">Âä†Á≤ó</el-checkbox>
          <el-checkbox v-model="formatDialog.form.italic">Êñú‰Ωì</el-checkbox>
          <el-checkbox v-model="formatDialog.form.underline">‰∏ãÂàíÁ∫ø</el-checkbox>
        </el-form-item>
      </el-form>
      <template #footer>
        <el-button @click="formatDialog.visible = false">ÂèñÊ∂à</el-button>
        <el-button type="primary" @click="applyFormat">Â∫îÁî®</el-button>
      </template>
    </el-dialog>

    <!-- ÊèíÂÖ•Ë°®Ê†ºÂØπËØùÊ°Ü -->
    <el-dialog v-model="insertTableDialog" title="ÊèíÂÖ•Ë°®Ê†º" width="500px">
      <el-form :model="insertTableForm" label-width="100px">
        <el-form-item label="Ë°åÊï∞">
          <el-input-number v-model="insertTableForm.rows" :min="1" :max="100" />
        </el-form-item>
        <el-form-item label="ÂàóÊï∞">
          <el-input-number v-model="insertTableForm.cols" :min="1" :max="50" />
        </el-form-item>
        <el-form-item label="Ë°®Â§¥">
          <el-checkbox v-model="insertTableForm.hasHeader" />
        </el-form-item>
        <el-form-item label="Êï∞ÊçÆ">
          <el-table :data="insertTableForm.data" border>
            <el-table-column v-for="col in insertTableForm.cols" :key="col" :label="`Âàó${col}`">
              <template #default="scope">
                <el-input v-model="scope.row[col]" />
              </template>
            </el-table-column>
          </el-table>
        </el-form-item>
      </el-form>
      <template #footer>
        <el-button @click="insertTableDialog = false">ÂèñÊ∂à</el-button>
        <el-button type="primary" @click="insertTable">Á°ÆÂÆö</el-button>
      </template>
    </el-dialog>

    <!-- ÂØºÂá∫ÂØπËØùÊ°Ü -->
    <el-dialog v-model="exportDialog" title="ÂØºÂá∫Êä•Ë°®" width="500px">
      <el-form :model="exportForm" label-width="100px">
        <el-form-item label="Ê†ºÂºè">
          <el-radio-group v-model="exportForm.format">
            <el-radio label="xlsx" />
            <el-radio label="pdf" />
          </el-radio-group>
        </el-form-item>
        <el-form-item label="ËåÉÂõ¥">
          <el-radio-group v-model="exportForm.range">
            <el-radio label="all">ÂÖ®ÈÉ®</el-radio>
            <el-radio label="selection">ÈÄâÊã©ËåÉÂõ¥</el-radio>
          </el-radio-group>
        </el-form-item>
        <el-form-item label="Êñá‰ª∂Âêç">
          <el-input v-model="exportForm.filename" />
        </el-form-item>
      </el-form>
      <template #footer>
        <el-button @click="exportDialog = false">ÂèñÊ∂à</el-button>
        <el-button type="primary" @click="exportReport">Á°ÆÂÆö</el-button>
      </template>
    </el-dialog>
  </div>
</template>

<script setup lang="ts">
import { ref, reactive, computed, onMounted, nextTick } from 'vue'
import { useRoute, useRouter } from 'vue-router'
import { ElMessage } from 'element-plus'
import {
  DocumentCopy, ArrowLeft, Delete, Grid, Rank, Close, Operation, Edit, Refresh,
  Plus, FolderOpened, Printer, RefreshLeft, RefreshRight, Position, Back, Right,
  Picture, TrendCharts, ScaleToOriginal, Link, Sort, Filter, CopyDocument, DocumentRemove, Star, Check,
  DataAnalysis, CirclePlus, Collection, Minus, Reading, Search, Document, Select, Download
} from '@element-plus/icons-vue'
import { reportApi, reportDataSourceApi } from '@/api/report'

// Á±ªÂûãÂÆö‰πâ
interface FieldInfo {
  name: string
  label: string
  type: string
  fieldType?: 'original' | 'computed'
  id?: number
  expression?: string
}

interface ComputedFieldInfo extends FieldInfo {
  id: number
  expression: string
  fieldType: 'computed'
}

// Props & Emits
interface Props {
  mode?: 'edit' | 'preview'
  reportData?: any
}

const props = defineProps<Props>()
const emit = defineEmits(['back'])

const route = useRoute()
const router = useRouter()

// ÂìçÂ∫îÂºèÊï∞ÊçÆ
const saving = ref(false)
const rendering = ref(false)
const rightPanelVisible = ref(true)
const selectedDataSource = ref('')
const cellFormula = ref('')

// üîÑ ÂàÜÁªÑ‰∏éÊ®°ÊùøÂèØËßÜ‰∫§‰∫íÂäüËÉΩ
// const groupEnabled = ref(false)
// const groupByField = ref('')
// const aggregationType = ref('sum')
// const reportTitle = ref('ÊúàÂ∫¶Â∞±ËØäÁªüËÆ°')

// Êù°‰ª∂Ê†∑ÂºèÈÖçÁΩÆ
const conditionalStyles = reactive<Record<string, any>>({})

// ÂèÇÊï∞ÂåñÊéß‰ª∂
const reportParameters = reactive<Record<string, any>>({})

// ÂçïÂÖÉÊ†ºÁºñËæëÁõ∏ÂÖ≥
const editingCell = ref<{row: number, col: string} | null>(null)
const editingValue = ref('')
const cellInputRef = ref<HTMLInputElement>()

// DOM ÂºïÁî®
const rowHeadersRef = ref<HTMLElement>()
const cellsAreaRef = ref<HTMLElement>()

// ÂêàÂπ∂ÂçïÂÖÉÊ†ºÊï∞ÊçÆÁªìÊûÑ
const mergedCells = reactive<Record<string, {
  rowspan: number
  colspan: number
  startRow: number
  startCol: string
  endRow: number
  endCol: string
}>>({})

// ÂàóÂÆΩË°åÈ´òÊï∞ÊçÆ
const columnWidths = reactive<Record<string, number>>({})
const rowHeights = reactive<Record<number, number>>({})
const defaultColumnWidth = 80
const defaultRowHeight = 21

// Ê∑ªÂä†ÂçïÂÖÉÊ†ºÊ†ºÂºèÊò†Â∞Ñ
const cellFormatMap = reactive<Record<string, any>>({})

// Ë∞ÉÊï¥Áä∂ÊÄÅ
const resizing = ref<{
  type: 'column' | 'row'
  target: string | number
  startX: number
  startY: number
  startSize: number
} | null>(null)

// üéØ ÈÄâÊã©ËåÉÂõ¥ÂäüËÉΩ
const selectionRange = reactive({
  start: { row: 0, col: '' },
  end: { row: 0, col: '' },
  active: false,
  selecting: false
})

// ÈÄâ‰∏≠ÁöÑÂçïÂÖÉÊ†ºËåÉÂõ¥
const selectedCells = computed(() => {
  if (!selectionRange.active) return []
  
  const cells: Array<{row: number, col: string}> = []
  const startRowIndex = Math.min(selectionRange.start.row, selectionRange.end.row)
  const endRowIndex = Math.max(selectionRange.start.row, selectionRange.end.row)
  const startColIndex = Math.min(
    getColumnIndex(selectionRange.start.col),
    getColumnIndex(selectionRange.end.col)
  )
  const endColIndex = Math.max(
    getColumnIndex(selectionRange.start.col), 
    getColumnIndex(selectionRange.end.col)
  )
  
  for (let row = startRowIndex; row <= endRowIndex; row++) {
    for (let colIndex = startColIndex; colIndex <= endColIndex; colIndex++) {
      const col = allColumns.value[colIndex]
      if (col) {
        cells.push({ row, col })
      }
    }
  }
  
  return cells
})

// Ê£ÄÊü•ÂçïÂÖÉÊ†ºÊòØÂê¶Âú®ÈÄâÊã©ËåÉÂõ¥ÂÜÖ
const isCellInSelection = (row: number, col: string) => {
  if (!selectionRange.active) return false
  return selectedCells.value.some(cell => cell.row === row && cell.col === col)
}

// ÁîüÊàêÂ§ßÈáèÂàóÂíåË°åÔºåÁúüÊ≠£ExcelÊÑüËßâ
const generateColumns = () => {
  const cols = []
  for (let i = 0; i < 26; i++) {
    cols.push(String.fromCharCode(65 + i)) // A-Z
  }
  for (let i = 0; i < 26; i++) {
    for (let j = 0; j < 26; j++) {
      cols.push(String.fromCharCode(65 + i) + String.fromCharCode(65 + j)) // AA-ZZ
    }
  }
  return cols.slice(0, 50) // ÊòæÁ§∫50Âàó
}

const allColumns = ref(generateColumns())
const allRows = computed(() => Array.from({ length: 100 }, (_, i) => i + 1)) // 100Ë°å

// ExcelÊ†∑ÂºèÁõ∏ÂÖ≥
const currentFont = ref('Microsoft YaHei')
const fontSize = ref(12)
const fontSizes = [8, 9, 10, 11, 12, 14, 16, 18, 20, 22, 24, 26, 28, 36, 48]
const selectedCell = reactive({ row: 1, col: 'A', ref: 'A1' })
const cellFormat = reactive({
  bold: false,
  italic: false,
  underline: false,
  color: '#000000',
  backgroundColor: '#ffffff',
  borderStyle: 'all' as 'all' | 'outer' | 'none',
  borderWidth: 1,
  borderColor: '#d1d5db',
  textAlign: 'left' as 'left' | 'center' | 'right'
})

// Êä•Ë°®Êï∞ÊçÆ
const reportData = reactive({
  id: null as number | null,
  name: '',
  config: {
    template: 'computed',
    dataSource: { type: 'table' as const, tableName: '', sqlQuery: '', apiUrl: '' },
    fields: { selected: [], mapping: {} }
  }
})

// Êï∞ÊçÆÊ∫êÁõ∏ÂÖ≥
const sourceData = ref<any[]>([])
const originalFields = ref<FieldInfo[]>([])
const computedFields = ref<ComputedFieldInfo[]>([])
const columnFieldMap = reactive<Record<string, FieldInfo>>({}) // Âàó‰∏éÂ≠óÊÆµÁöÑÊò†Â∞Ñ
const renderedData = reactive<Record<string, string>>({}) // Ê∏≤ÊüìÂêéÁöÑÊï∞ÊçÆ
const availableDataSources = ref<Array<{label: string, value: string}>>([]) // ÂèØÁî®Êï∞ÊçÆÊ∫êÂàóË°®

// ÂèØÊãñÊãΩÁªÑ‰ª∂ÂàóË°®
const availableComponents = ref([
  { type: 'text', name: 'ÊñáÊú¨', icon: 'Reading' },
  { type: 'table', name: 'Ë°®Ê†º', icon: 'Grid' },
  { type: 'chart', name: 'ÂõæË°®', icon: 'TrendCharts' },
  { type: 'image', name: 'ÂõæÁâá', icon: 'Picture' }
])

// ËÆ°ÁÆóÂ≠óÊÆµË°®Âçï
const computedFieldForm = reactive({
  label: '',
  expression: '',
  type: 'string'
})

// ËÆ°ÁÆóÂ±ûÊÄß
const canCreateField = computed(() => {
  return computedFieldForm.label.trim() && computedFieldForm.expression.trim()
})

// ÊãñÊãΩÁä∂ÊÄÅ
const isDragOverColumn = ref<string | null>(null)

// ÂÖ¨ÂºèËÆ°ÁÆóÁõ∏ÂÖ≥
const isFormulaDragOver = ref(false)
const columnFormulas = reactive<Record<string, string>>({}) // ÂàóÁ∫ßÂÖ¨ÂºèÂ≠òÂÇ®
const currentEditingColumn = ref<string>('')

// üéØ Êñ∞Â¢ûÔºöË°®Ê†ºÊèíÂÖ•ÂíåÂØºÂá∫ÂäüËÉΩ
const insertTableDialog = ref(false)
const insertTableForm = reactive({
  rows: 3,
  cols: 3,
  hasHeader: true,
  data: [] as string[][]
})

const exportDialog = ref(false)
const exportForm = reactive({
  format: 'xlsx' as 'xlsx' | 'pdf',
  range: 'all' as 'all' | 'selection',
  filename: 'Êä•Ë°®ÂØºÂá∫'
})

// ÊñπÊ≥ï
const toggleRightPanel = () => {
  rightPanelVisible.value = !rightPanelVisible.value
}

// üéØ Ê®°ÊùøÂèØËßÜ‰∫§‰∫íÂäüËÉΩÊñπÊ≥ï

// Êä•Ë°®Ê†áÈ¢òËÆæÁΩÆ
// const setReportTitle = () => {
//   renderedData['A1'] = reportTitle.value
//   ElMessage.success('Êä•Ë°®Ê†áÈ¢òÂ∑≤ËÆæÁΩÆÂà∞A1ÂçïÂÖÉÊ†º')
// }

// Âø´ÈÄüËÆæÁΩÆË°®Â§¥
// const setupTableHeaders = () => {
//   renderedData['A2'] = 'ÁßëÂÆ§'
//   renderedData['B2'] = 'Êúà‰ªΩ'
//   renderedData['C2'] = 'Â∞±ËØä‰∫∫Êï∞'
//   ElMessage.success('Ë°®Â§¥Â∑≤ËÆæÁΩÆÂÆåÊàêÔºöA2-ÁßëÂÆ§ÔºåB2-Êúà‰ªΩÔºåC2-Â∞±ËØä‰∫∫Êï∞')
// }

// Ëé∑ÂèñÂ≠óÊÆµÊòæÁ§∫ÂêçÁß∞
// const getFieldLabel = (fieldName: string): string => {
//   const field = originalFields.value.find(f => f.name === fieldName)
//   return field ? field.label : fieldName
// }

// ÂàÜÁªÑÂºÄÂÖ≥Â§ÑÁêÜ
// const handleGroupToggle = () => {
//   if (!groupEnabled.value) {
//     groupByField.value = ''
//     updateRender()
//   }
// }

// Â∫îÁî®ÂàÜÁªÑËÆæÁΩÆ
// const applyGrouping = () => {
//   if (!groupEnabled.value || !groupByField.value) return
//   
//   try {
//     const groupedData = groupDataByField(sourceData.value, groupByField.value, aggregationType.value)
//     
//     // Ê∏ÖÁ©∫Áé∞ÊúâÊ∏≤ÊüìÊï∞ÊçÆÔºà‰øùÁïôÊ†áÈ¢òÂíåË°®Â§¥Ôºâ
//     Object.keys(renderedData).forEach(key => {
//       if (key.match(/^[A-Z][3-9]/) || key.match(/^[A-Z][1-9]\d+/)) {
//         delete renderedData[key]
//       }
//     })
//     
//     renderGroupedData(groupedData)
//     ElMessage.success(`Â∑≤Êåâ"${getFieldLabel(groupByField.value)}"ËøõË°å${aggregationType.value}ÂàÜÁªÑ`)
//   } catch (error: any) {
//     ElMessage.error('ÂàÜÁªÑÂ§±Ë¥•: ' + error.message)
//   }
// }

// Êï∞ÊçÆÂàÜÁªÑÈÄªËæë
// const groupDataByField = (data: any[], fieldName: string, aggType: string) => {
//   const grouped: Record<string, any[]> = {}
//   
//   // ÊåâÂ≠óÊÆµÂàÜÁªÑ
//   data.forEach(item => {
//     const key = String(item[fieldName] || 'Unknown')
//     if (!grouped[key]) {
//       grouped[key] = []
//     }
//     grouped[key].push(item)
//   })
//   
//   // ËÆ°ÁÆóËÅöÂêàÂÄº
//   const result: any[] = []
//   Object.keys(grouped).forEach(key => {
//     const items = grouped[key]
//     const aggregatedItem: any = { [fieldName]: key }
//     
//     // ÂØπÊï∞ÂÄºÂ≠óÊÆµËøõË°åËÅöÂêàËÆ°ÁÆó
//     originalFields.value.forEach(field => {
//       if (field.type === 'number' && field.name !== fieldName) {
//         const values = items.map(item => Number(item[field.name]) || 0)
//         
//         switch (aggType) {
//           case 'sum':
//             aggregatedItem[field.name] = values.reduce((sum, val) => sum + val, 0)
//             break
//           case 'avg':
//             aggregatedItem[field.name] = values.length > 0 ? values.reduce((sum, val) => sum + val, 0) / values.length : 0
//             break
//           case 'count':
//             aggregatedItem[field.name] = items.length
//             break
//           default:
//             aggregatedItem[field.name] = values.reduce((sum, val) => sum + val, 0)
//         }
//       } else if (field.name !== fieldName) {
//         aggregatedItem[field.name] = items[0][field.name]
//       }
//     })
//     
//     result.push(aggregatedItem)
//   })
//   
//   return result
// }

// Ê∏≤ÊüìÂàÜÁªÑÊï∞ÊçÆ
// const renderGroupedData = (groupedData: any[]) => {
//   groupedData.forEach((row, index) => {
//     const rowNum = index + 3 // ‰ªéÁ¨¨3Ë°åÂºÄÂßã
//     
//     Object.keys(columnFieldMap).forEach(col => {
//       const field = columnFieldMap[col]
//       const value = row[field.name]
//       
//       if (value !== undefined && value !== null) {
//         if (field.type === 'number' && typeof value === 'number') {
//           renderedData[`${col}${rowNum}`] = value.toLocaleString()
//         } else {
//           renderedData[`${col}${rowNum}`] = String(value)
//         }
//       } else {
//         renderedData[`${col}${rowNum}`] = ''
//       }
//     })
//   })
// }

// ‰∏ÄÈîÆÂÆåÊàêÂÖ∏ÂûãÂú∫ÊôØ
const autoCompleteScenario = async () => {
  try {
    rendering.value = true
    
    // Á°Æ‰øùÈÄâÊã©‰∫ÜÊ≠£Á°ÆÁöÑÊï∞ÊçÆÊ∫ê
    if (selectedDataSource.value !== 'visit_stat_monthly') {
      selectedDataSource.value = 'visit_stat_monthly'
      await loadDataSource()
    }
    
    // ËÆæÁΩÆÊä•Ë°®Ê†áÈ¢ò
    const reportTitle = 'ÊúàÂ∫¶Â∞±ËØäÁªüËÆ°'
    renderedData['A1'] = reportTitle
    
    // ËÆæÁΩÆË°®Â§¥
    renderedData['A2'] = 'ÁßëÂÆ§'
    renderedData['B2'] = 'Êúà‰ªΩ' 
    renderedData['C2'] = 'Â∞±ËØä‰∫∫Êï∞'
    
    // Â≠óÊÆµÁªëÂÆö
    const fields = originalFields.value
    if (fields.length >= 3) {
      const deptField = fields.find(f => f.name === 'department_name')
      const monthField = fields.find(f => f.name === 'visit_month')
      const countField = fields.find(f => f.name === 'visit_count')
      
      if (deptField) columnFieldMap['A'] = deptField
      if (monthField) columnFieldMap['B'] = monthField
      if (countField) columnFieldMap['C'] = countField
    }
    
    // Ê∏≤ÊüìÊï∞ÊçÆ
    sourceData.value.forEach((row, index) => {
      const rowNum = index + 3
      if (columnFieldMap['A']) renderedData[`A${rowNum}`] = row.department_name || ''
      if (columnFieldMap['B']) renderedData[`B${rowNum}`] = row.visit_month || ''
      if (columnFieldMap['C']) {
        const count = row.visit_count
        renderedData[`C${rowNum}`] = typeof count === 'number' ? count.toLocaleString() : String(count || 0)
      }
    })
    
    ElMessage.success('üéâ Âú∫ÊôØÂÆåÊàêÔºÅÂ∑≤Ëá™Âä®ËÆæÁΩÆÊ†áÈ¢ò„ÄÅË°®Â§¥Âπ∂ÁªëÂÆöÊï∞ÊçÆ')
    
  } catch (error: any) {
    ElMessage.error('Âú∫ÊôØËÆæÁΩÆÂ§±Ë¥•: ' + error.message)
  } finally {
    rendering.value = false
  }
}

const loadAvailableDataSources = async () => {
  try {
    const tableResult = await reportDataSourceApi.getTableList()
    if (tableResult.code === 200) {
      // Â§ÑÁêÜÂèØËÉΩÁöÑÂµåÂ•óÊï∞ÊçÆÁªìÊûÑ
      let tables = tableResult.data
      if (tables && typeof tables === 'object' && 'data' in tables) {
        tables = (tables as any).data
      }
      
      // Á°Æ‰øùtablesÊòØÊï∞ÁªÑ
      const tableArray = Array.isArray(tables) ? tables : []
      availableDataSources.value = tableArray
        .filter((table: any) => !table.name.startsWith('_') && table.type === 'BASE TABLE')
        .map((table: any) => ({
          label: table.name,
          value: table.name
        }))
      
      // Â¶ÇÊûúÊ≤°ÊúâÈÄâ‰∏≠ÁöÑÊï∞ÊçÆÊ∫êÔºåÈªòËÆ§ÈÄâÊã©Á¨¨‰∏Ä‰∏™
      if (!selectedDataSource.value && availableDataSources.value.length > 0) {
        selectedDataSource.value = availableDataSources.value[0].value
      }
    }
  } catch (error) {
    console.error('Âä†ËΩΩÊï∞ÊçÆÊ∫êÂàóË°®Â§±Ë¥•:', error)
    // ‰ΩøÁî®ÈªòËÆ§Êï∞ÊçÆÊ∫ê
    availableDataSources.value = [
      { label: 'ÊÇ£ËÄÖÂ∞±ËØä‰ø°ÊÅØ', value: 'visit_info' },
      { label: 'ÊúàÂ∫¶Â∞±ËØäÁªüËÆ°', value: 'visit_stat_monthly' },
      { label: 'Áî®Êà∑ÁÆ°ÁêÜ', value: 'users' },
      { label: 'ÈÉ®Èó®ÁªüËÆ°', value: 'departments' }
    ]
    // ËÆæÁΩÆÈªòËÆ§ÈÄâÊã©
    selectedDataSource.value = 'visit_stat_monthly'
  }
}

const loadDataSource = async () => {
  if (!selectedDataSource.value) return
  
  try {
    // Ëé∑ÂèñË°®ÁªìÊûÑ
    const structResult = await reportDataSourceApi.getTableStructure(selectedDataSource.value)
    if (structResult.code === 200) {
      // Â§ÑÁêÜÂèØËÉΩÁöÑÂµåÂ•óÊï∞ÊçÆÁªìÊûÑ
      let fields = structResult.data
      if (fields && typeof fields === 'object' && 'data' in fields) {
        fields = (fields as any).data
      }
      
      // Á°Æ‰øùfieldsÊòØÊï∞ÁªÑ
      const fieldsArray = Array.isArray(fields) ? fields : []
      originalFields.value = fieldsArray.map((field: any) => ({
        name: field.name,
        label: field.comment || field.name,
        type: mapFieldType(field.type),
        fieldType: 'original' as const
      }))
    }
    
    // Ëé∑ÂèñË°®Êï∞ÊçÆ
    const dataResult = await reportDataSourceApi.getTableData(selectedDataSource.value, 50)
    if (dataResult.code === 200) {
      // Â§ÑÁêÜÂèØËÉΩÁöÑÂµåÂ•óÊï∞ÊçÆÁªìÊûÑ
      let data = dataResult.data
      if (data && typeof data === 'object' && 'data' in data) {
        data = (data as any).data
      }
      // Á°Æ‰øùdataÊòØÊï∞ÁªÑ
      sourceData.value = Array.isArray(data) ? data : []
    }
    
    ElMessage.success(`Êï∞ÊçÆÊ∫ê "${selectedDataSource.value}" Âä†ËΩΩÊàêÂäü`)
  } catch (error) {
    console.error('Âä†ËΩΩÊï∞ÊçÆÊ∫êÂ§±Ë¥•:', error)
    ElMessage.error('Âä†ËΩΩÊï∞ÊçÆÊ∫êÂ§±Ë¥•Ôºå‰ΩøÁî®Ê®°ÊãüÊï∞ÊçÆ')
    loadMockData()
  }
}

const loadMockData = () => {
  // Ê®°ÊãüÊï∞ÊçÆÊ∫êÈÖçÁΩÆ - ‰Ωú‰∏∫Â§áÁî®ÊñπÊ°à
  const dataSources: Record<string, { fields: FieldInfo[], data: any[] }> = {
    'visit_info': {
      fields: [
        { name: 'patient_name', label: 'ÊÇ£ËÄÖÂßìÂêç', type: 'string' },
        { name: 'visit_date', label: 'Â∞±ËØäÊó∂Èó¥', type: 'datetime' },
        { name: 'department', label: 'ÁßëÂÆ§', type: 'string' },
        { name: 'doctor_name', label: '‰∏ªËØäÂåªÁîü', type: 'string' },
        { name: 'diagnosis', label: 'ËØäÊñ≠', type: 'text' },
        { name: 'age', label: 'Âπ¥ÈæÑ', type: 'number' }
      ],
      data: [
        { patient_name: 'Âº†‰∏â', visit_date: '2024-01-15 09:30', department: 'ÂÜÖÁßë', doctor_name: 'ÊùéÂåªÁîü', diagnosis: 'È´òË°ÄÂéã', age: 45 },
        { patient_name: 'ÊùéÂõõ', visit_date: '2024-01-15 10:15', department: 'Â§ñÁßë', doctor_name: 'ÁéãÂåªÁîü', diagnosis: 'ÈòëÂ∞æÁÇé', age: 32 },
        { patient_name: 'Áéã‰∫î', visit_date: '2024-01-15 11:00', department: 'ÂÑøÁßë', doctor_name: 'ËµµÂåªÁîü', diagnosis: 'ÊÑüÂÜí', age: 8 }
      ]
    },
    'visit_stat_monthly': {
      fields: [
        { name: 'department_name', label: 'ÁßëÂÆ§ÂêçÁß∞', type: 'string' },
        { name: 'visit_month', label: 'Â∞±ËØäÊúà‰ªΩ', type: 'string' },
        { name: 'visit_count', label: 'Â∞±ËØä‰∫∫Êï∞', type: 'number' }
      ],
      data: [
        { department_name: 'ÂÜÖÁßë', visit_month: '2024-01', visit_count: 158 },
        { department_name: 'ÂÜÖÁßë', visit_month: '2024-02', visit_count: 142 },
        { department_name: 'ÂÜÖÁßë', visit_month: '2024-03', visit_count: 173 },
        { department_name: 'Â§ñÁßë', visit_month: '2024-01', visit_count: 89 },
        { department_name: 'Â§ñÁßë', visit_month: '2024-02', visit_count: 95 },
        { department_name: 'Â§ñÁßë', visit_month: '2024-03', visit_count: 108 },
        { department_name: 'ÂÑøÁßë', visit_month: '2024-01', visit_count: 234 },
        { department_name: 'ÂÑøÁßë', visit_month: '2024-02', visit_count: 198 },
        { department_name: 'ÂÑøÁßë', visit_month: '2024-03', visit_count: 267 },
        { department_name: 'Â¶á‰∫ßÁßë', visit_month: '2024-01', visit_count: 76 },
        { department_name: 'Â¶á‰∫ßÁßë', visit_month: '2024-02', visit_count: 82 },
        { department_name: 'Â¶á‰∫ßÁßë', visit_month: '2024-03', visit_count: 91 }
      ]
    }
  }
  
  if (selectedDataSource.value && dataSources[selectedDataSource.value]) {
    const ds = dataSources[selectedDataSource.value]
    originalFields.value = ds.fields
    sourceData.value = ds.data
  }
}

// Êò†Â∞ÑÊï∞ÊçÆÂ∫ìÂ≠óÊÆµÁ±ªÂûãÂà∞ÁïåÈù¢Á±ªÂûã
const mapFieldType = (dbType: string): string => {
  const type = dbType.toLowerCase()
  if (type.includes('varchar') || type.includes('char') || type.includes('text')) return 'string'
  if (type.includes('int') || type.includes('decimal') || type.includes('float') || type.includes('double')) return 'number'
  if (type.includes('datetime') || type.includes('timestamp') || type.includes('date')) return 'datetime'
  if (type.includes('boolean') || type.includes('tinyint(1)')) return 'boolean'
  return 'string'
}

const getFieldTypeColor = (type: string) => {
  const colors: Record<string, string> = {
    'string': 'primary',
    'number': 'success',
    'datetime': 'warning',
    'text': 'info',
    'boolean': 'danger'
  }
  return colors[type] || 'default'
}

const getColumnField = (col: string): FieldInfo | null => {
  return columnFieldMap[col] || null
}

const getCellValue = (row: number, col: string): string => {
  const cellKey = `${col}${row}`
  return renderedData[cellKey] || ''
}

const getCellClass = (row: number, col: string) => {
  const classes = []
  
  // ÂΩìÂâçÈÄâ‰∏≠ÁöÑÂçïÂÖÉÊ†º
  if (selectedCell.row === row && selectedCell.col === col) {
    classes.push('selected')
  }
  
  // Âú®ÈÄâÊã©ËåÉÂõ¥ÂÜÖÁöÑÂçïÂÖÉÊ†º
  if (isCellInSelection(row, col)) {
    classes.push('in-selection')
  }
  
  // ÈÄâÊã©ËåÉÂõ¥ÁöÑËµ∑ÂßãÂçïÂÖÉÊ†º
  if (selectionRange.active && 
      selectionRange.start.row === row && 
      selectionRange.start.col === col) {
    classes.push('selection-start')
  }
  
  // ÈÄâÊã©ËåÉÂõ¥ÁöÑÁªìÊùüÂçïÂÖÉÊ†º
  if (selectionRange.active && 
      selectionRange.end.row === row && 
      selectionRange.end.col === col) {
    classes.push('selection-end')
  }
  
  // ÊòØÂê¶ÊúâÂêàÂπ∂‰ø°ÊÅØ
  const cellKey = `${col}${row}`
  if (mergedCells[cellKey]) {
    classes.push('merged-cell')
  }
  
  return classes
}

const getCellStyle = (row: number, col: string) => {
  const cellKey = `${col}${row}`
  const cellFormats = cellFormatMap[cellKey] || {}
  
  return {
    fontFamily: cellFormats.fontFamily || currentFont.value,
    fontSize: (cellFormats.fontSize || fontSize.value) + 'px',
    fontWeight: cellFormats.bold ? 'bold' : 'normal',
    fontStyle: cellFormats.italic ? 'italic' : 'normal',
    textDecoration: cellFormats.underline ? 'underline' : 'none',
    color: cellFormats.color || '#000',
    backgroundColor: cellFormats.backgroundColor || 'transparent',
    textAlign: cellFormats.textAlign || 'left',
    width: (columnWidths[col] || defaultColumnWidth) + 'px',
    maxWidth: (columnWidths[col] || defaultColumnWidth) + 'px',
    minWidth: (columnWidths[col] || defaultColumnWidth) + 'px'
  }
}

const selectCell = (row: number, col: string, event?: MouseEvent) => {
  // Ê£ÄÊü•ÊòØÂê¶Êåâ‰∏ãShiftÈîÆËøõË°åËåÉÂõ¥ÈÄâÊã©
  if (event && event.shiftKey && selectionRange.active) {
    // Êâ©Â±ïÈÄâÊã©ËåÉÂõ¥
    selectionRange.end = { row, col }
  } else {
    // Âçï‰∏™ÂçïÂÖÉÊ†ºÈÄâÊã©
    selectedCell.row = row
    selectedCell.col = col
    selectedCell.ref = `${col}${row}`
    
    // ÂºÄÂßãÊñ∞ÁöÑÈÄâÊã©ËåÉÂõ¥
    selectionRange.start = { row, col }
    selectionRange.end = { row, col }
    selectionRange.active = true
    selectionRange.selecting = false
  }
  
  // Êõ¥Êñ∞ÂÖ¨ÂºèÊ†è
  const cellKey = `${col}${row}`
  cellFormula.value = renderedData[cellKey] || ''
}

const editCell = (row: number, col: string) => {
  selectCell(row, col) // ÂÜÖÈÉ®Ë∞ÉÁî®Ôºå‰∏çÈúÄË¶ÅeventÂèÇÊï∞
  editingCell.value = { row, col }
  editingValue.value = getCellValue(row, col)
  
  // Âú®‰∏ã‰∏Ä‰∏™ tick ‰∏≠ËÅöÁÑ¶ËæìÂÖ•Ê°Ü
  nextTick(() => {
    // Êü•ÊâæÂΩìÂâçÁºñËæëÂçïÂÖÉÊ†ºÁöÑËæìÂÖ•Ê°Ü
    const cellKey = `${col}${row}`
    const inputElement = document.querySelector(`.cell-input`) as HTMLInputElement
    if (inputElement) {
      inputElement.focus()
      inputElement.select()
    }
  })
}

const isEditing = (row: number, col: string): boolean => {
  return editingCell.value?.row === row && editingCell.value?.col === col
}

const finishEdit = () => {
  if (editingCell.value) {
    const cellKey = `${editingCell.value.col}${editingCell.value.row}`
    let value = editingValue.value
    
    // Â§ÑÁêÜË°®ËææÂºèËÆ°ÁÆó
    if (value.startsWith('=')) {
      try {
        // ‰ΩøÁî®Êñ∞ÁöÑÁÆÄÂåñË°®ËææÂºèËÆ°ÁÆó
        const result = evaluateSimpleExpression(value.substring(1))
        renderedData[cellKey] = String(result)
      } catch (error) {
        renderedData[cellKey] = '#ERROR!'
        ElMessage.error('Ë°®ËææÂºèËÆ°ÁÆóÈîôËØØ')
      }
    } else {
      // Êï∞ÊçÆÁ±ªÂûãÊ£ÄÊµãÂíåÊ†ºÂºèÂåñ
      const formattedValue = formatCellValue(value)
      renderedData[cellKey] = formattedValue
    }
    
    editingCell.value = null
    editingValue.value = ''
  }
}

const cancelEdit = () => {
  editingCell.value = null
  editingValue.value = ''
}

const applyFormula = () => {
  if (currentEditingColumn.value) {
    // Â∫îÁî®ÂÖ¨ÂºèÂà∞Êï¥Âàó
    applyFormulaToColumn(currentEditingColumn.value, cellFormula.value)
  } else {
    // Â∫îÁî®Âà∞Âçï‰∏™ÂçïÂÖÉÊ†º
    const cellKey = `${selectedCell.col}${selectedCell.row}`
    try {
      const sampleData = sourceData.value[0] || {}
      const result = evaluateFormula(cellFormula.value, sampleData)
      renderedData[cellKey] = String(result)
      ElMessage.success('ÂÖ¨ÂºèÂ∫îÁî®ÊàêÂäü')
    } catch (error) {
      renderedData[cellKey] = cellFormula.value
      ElMessage.warning('‰Ωú‰∏∫ÊôÆÈÄöÊñáÊú¨‰øùÂ≠ò')
    }
  }
}

// üßÆ ÂÖ¨ÂºèËÆ°ÁÆóÊ†∏ÂøÉÂäüËÉΩ

// Â§ÑÁêÜÂ≠óÊÆµÊãñÊãΩÂà∞ÂÖ¨ÂºèÊ†è
const handleFormulaDrop = (event: DragEvent) => {
  event.preventDefault()
  isFormulaDragOver.value = false
  
  try {
    const fieldData = event.dataTransfer?.getData('application/json')
    if (fieldData) {
      const field = JSON.parse(fieldData) as FieldInfo
      
      // Âú®ÂÖâÊ†á‰ΩçÁΩÆÊèíÂÖ•Â≠óÊÆµÂºïÁî®
      const input = event.target as HTMLInputElement
      const cursorPos = input.selectionStart || 0
      const beforeText = cellFormula.value.substring(0, cursorPos)
      const afterText = cellFormula.value.substring(cursorPos)
      
      const fieldReference = `\${${field.name}}`
      cellFormula.value = beforeText + fieldReference + afterText
      
      ElMessage.success(`Â≠óÊÆµ "${field.label}" Â∑≤ÊèíÂÖ•ÂÖ¨Âºè`)
      
      // ÈáçÊñ∞ËÆæÁΩÆÂÖâÊ†á‰ΩçÁΩÆ
      setTimeout(() => {
        const newPos = cursorPos + fieldReference.length
        input.setSelectionRange(newPos, newPos)
        input.focus()
      }, 0)
    }
  } catch (error) {
    console.error('ÂÖ¨ÂºèÊãñÊãΩÂ§ÑÁêÜÂ§±Ë¥•:', error)
    ElMessage.error('Â≠óÊÆµÊèíÂÖ•Â§±Ë¥•')
  }
}

// Ëé∑ÂèñÂÖ¨ÂºèÈ¢ÑËßàÁªìÊûú
const getFormulaPreview = (): string => {
  if (!cellFormula.value) return ''
  
  try {
    // Â¶ÇÊûúÂΩìÂâçÊòØÂàóÊ†áÈ¢òÔºåÂàô‰ΩøÁî®Á¨¨‰∏ÄË°åÊï∞ÊçÆËøõË°åÈ¢ÑËßà
    const sampleData = sourceData.value[0] || {}
    const result = evaluateFormula(cellFormula.value, sampleData)
    return String(result)
  } catch (error) {
    return 'ÂÖ¨ÂºèÈîôËØØ'
  }
}

// ÂÖ¨ÂºèËÆ°ÁÆóÂºïÊìé
const evaluateFormula = (formula: string, data: any): any => {
  let expression = formula.trim()
  
  // Â¶ÇÊûú‰∏çÊòØÂÖ¨ÂºèÔºà‰∏çÂåÖÂê´${}ÔºâÔºåÁõ¥Êé•ËøîÂõûÂéüÂÄº
  if (!expression.includes('${')) {
    return expression
  }
  
  // ÊõøÊç¢Â≠óÊÆµÂºïÁî® ${field_name} ‰∏∫ÂÆûÈôÖÂÄº
  originalFields.value.forEach(field => {
    const fieldRef = `\${${field.name}}`
    if (expression.includes(fieldRef)) {
      const value = data[field.name]
      
      if (field.type === 'number') {
        expression = expression.replace(new RegExp(`\\$\\{${field.name}\\}`, 'g'), String(value || 0))
      } else {
        expression = expression.replace(new RegExp(`\\$\\{${field.name}\\}`, 'g'), `"${value || ''}"`)
      }
    }
  })
  
  // ÂÆâÂÖ®ËÆ°ÁÆóË°®ËææÂºè
  try {
    // Âè™ÂÖÅËÆ∏ÂÆâÂÖ®ÁöÑÊï∞Â≠¶ËøêÁÆóÂíåÊØîËæÉ
    const safeExpression = expression.replace(/[^0-9+\-*/().,\s"<>=!&|]/g, '')
    return new Function('return ' + safeExpression)()
  } catch (error) {
    throw new Error('ÂÖ¨ÂºèËÆ°ÁÆóÈîôËØØ')
  }
}

// Â∫îÁî®ÂÖ¨ÂºèÂà∞Âàó
const applyFormulaToColumn = (col: string, formula: string) => {
  console.log(`üßÆ Â∫îÁî®ÂÖ¨ÂºèÂà∞Âàó ${col}:`, formula)
  
  // ‰øùÂ≠òÂàóÂÖ¨Âºè
  columnFormulas[col] = formula
  
  // ÂØπÊâÄÊúâÊï∞ÊçÆË°åÂ∫îÁî®ÂÖ¨Âºè
  sourceData.value.forEach((row, index) => {
    const rowNum = index + 3 // ‰ªéÁ¨¨3Ë°åÂºÄÂßã
    const cellKey = `${col}${rowNum}`
    
    try {
      const result = evaluateFormula(formula, row)
      if (typeof result === 'number') {
        renderedData[cellKey] = result.toLocaleString()
      } else {
        renderedData[cellKey] = String(result)
      }
    } catch (error) {
      renderedData[cellKey] = 'ERROR'
    }
  })
  
  ElMessage.success(`Âàó ${col} ÂÖ¨ÂºèÂ∫îÁî®ÂÆåÊàê`)
}

// ÈÄâ‰∏≠ÂàóÊ†áÈ¢òÊó∂ÁöÑÂ§ÑÁêÜ
const selectColumnHeader = (col: string) => {
  currentEditingColumn.value = col
  selectedCell.col = col
  selectedCell.row = 2 // Ë°®Â§¥Ë°å
  selectedCell.ref = `${col}2`
  
  // Â¶ÇÊûúËØ•ÂàóÊúâÂÖ¨ÂºèÔºåÊòæÁ§∫Âú®ÂÖ¨ÂºèÊ†è
  if (columnFormulas[col]) {
    cellFormula.value = columnFormulas[col]
  } else if (columnFieldMap[col]) {
    // Â¶ÇÊûúÊúâÂ≠óÊÆµÁªëÂÆöÔºåÊòæÁ§∫Â≠óÊÆµÂºïÁî®
    cellFormula.value = `\${${columnFieldMap[col].name}}`
  } else {
    cellFormula.value = ''
  }
  
  ElMessage.info(`ÈÄâ‰∏≠Âàó ${col}ÔºåÂèØÂú®ÂÖ¨ÂºèÊ†èÁºñËæëÂàóÂÖ¨Âºè`)
}

const handleScroll = (event: any) => {
  // ÂêåÊ≠•Ë°åÊ†áÈ¢ò‰∏éÂçïÂÖÉÊ†ºÁöÑÂûÇÁõ¥ÊªöÂä®
  if (rowHeadersRef.value && cellsAreaRef.value) {
    rowHeadersRef.value.scrollTop = cellsAreaRef.value.scrollTop
  }
}

const handleFieldDragStart = (event: DragEvent, field: FieldInfo, type: 'original' | 'computed') => {
  if (event.dataTransfer) {
    const dragData = {
      ...field,
      fieldType: type
    }
    event.dataTransfer.setData('application/json', JSON.stringify(dragData))
    event.dataTransfer.effectAllowed = 'copy'
    console.log('üî• ÂºÄÂßãÊãñÊãΩÂ≠óÊÆµ:', field.label)
  }
}

const handleColumnDrop = (event: DragEvent, col: string) => {
  event.preventDefault()
  isDragOverColumn.value = null
  
  try {
    const fieldData = event.dataTransfer?.getData('application/json')
    if (fieldData) {
      const field = JSON.parse(fieldData) as FieldInfo
      
      // ÁªëÂÆöÂ≠óÊÆµÂà∞Âàó
      columnFieldMap[col] = field
      
      console.log(`‚úÖ Â≠óÊÆµ "${field.label}" Â∑≤ÁªëÂÆöÂà∞Âàó ${col}`)
      ElMessage.success(`Â≠óÊÆµ "${field.label}" Â∑≤ÁªëÂÆöÂà∞ ${col} Âàó`)
      
      // Á´ãÂç≥Ê∏≤ÊüìÊï∞ÊçÆÂà∞ËØ•Âàó
      renderColumnData(col, field)
    }
  } catch (error) {
    console.error('ÊãñÊãΩÂ§ÑÁêÜÂ§±Ë¥•:', error)
    ElMessage.error('Â≠óÊÆµÁªëÂÆöÂ§±Ë¥•')
  }
}

// ÂçïÁã¨Ê∏≤ÊüìÂàóÊï∞ÊçÆ
const renderColumnData = (col: string, field: FieldInfo) => {
  console.log(`üîÑ Ê∏≤ÊüìÂàó ${col} ÁöÑÊï∞ÊçÆÔºåÂ≠óÊÆµ:`, field.label)
  
  sourceData.value.forEach((row, index) => {
    const rowNum = index + 3 // ‰ªéÁ¨¨3Ë°åÂºÄÂßãÔºàÁ¨¨1Ë°åÊ†áÈ¢òÔºåÁ¨¨2Ë°åË°®Â§¥Ôºâ
    const cellKey = `${col}${rowNum}`
    
    const value = row[field.name]
    if (value !== undefined && value !== null) {
      if (field.type === 'number' && typeof value === 'number') {
        renderedData[cellKey] = value.toLocaleString()
      } else {
        renderedData[cellKey] = String(value)
      }
    } else {
      renderedData[cellKey] = ''
    }
  })
  
  console.log(`‚úÖ Âàó ${col} Êï∞ÊçÆÊ∏≤ÊüìÂÆåÊàê`)
}

// ÊãñÊãΩÊÇ¨ÂÅúÂ§ÑÁêÜ
const handleDragOver = (event: DragEvent, col: string) => {
  event.preventDefault()
  isDragOverColumn.value = col
}

const handleDragEnter = (event: DragEvent, col: string) => {
  event.preventDefault()
  isDragOverColumn.value = col
}

const handleDragLeave = (event: DragEvent, col: string) => {
  const rect = (event.currentTarget as HTMLElement).getBoundingClientRect()
  const x = event.clientX
  const y = event.clientY
  
  if (x < rect.left || x > rect.right || y < rect.top || y > rect.bottom) {
    isDragOverColumn.value = null
  }
}

const removeColumnField = (col: string) => {
  delete columnFieldMap[col]
  // Ê∏ÖÈô§ËØ•ÂàóÁöÑÊ∏≤ÊüìÊï∞ÊçÆ
  allRows.value.forEach(row => {
    delete renderedData[`${col}${row}`]
  })
}

const updateRender = async () => {
  rendering.value = true
  try {
    // ÈáçÊñ∞Ê∏≤ÊüìÊï∞ÊçÆ
    await new Promise(resolve => setTimeout(resolve, 500))
    ElMessage.success('Êï∞ÊçÆÊ∏≤ÊüìÂÆåÊàê')
  } catch (error: any) {
    ElMessage.error('Ê∏≤ÊüìÂ§±Ë¥•: ' + error.message)
  } finally {
    rendering.value = false
  }
}

const createComputedField = () => {
  if (!canCreateField.value) return
  
  // È™åËØÅË°®ËææÂºè
  try {
    const testRow = sourceData.value[0] || {}
    evaluateExpression(computedFieldForm.expression, testRow)
  } catch (error: any) {
    ElMessage.error('Ë°®ËææÂºèÈîôËØØ: ' + error.message)
    return
  }
  
  const newField: ComputedFieldInfo = {
    id: Date.now(),
    name: 'computed_' + Date.now(),
    label: computedFieldForm.label,
    expression: computedFieldForm.expression,
    type: computedFieldForm.type,
    fieldType: 'computed'
  }
  
  computedFields.value.push(newField)
  resetComputedForm()
  ElMessage.success(`ËÆ°ÁÆóÂ≠óÊÆµ "${newField.label}" ÂàõÂª∫ÊàêÂäü`)
}

const editComputedField = (field: ComputedFieldInfo) => {
  computedFieldForm.label = field.label
  computedFieldForm.expression = field.expression
  computedFieldForm.type = field.type
  
  deleteComputedField(field.id)
}

const deleteComputedField = (fieldId: number) => {
  const index = computedFields.value.findIndex(f => f.id === fieldId)
  if (index > -1) {
    computedFields.value.splice(index, 1)
    ElMessage.success('ËÆ°ÁÆóÂ≠óÊÆµÂ∑≤Âà†Èô§')
  }
}

const resetComputedForm = () => {
  computedFieldForm.label = ''
  computedFieldForm.expression = ''
  computedFieldForm.type = 'string'
}

const evaluateExpression = (expression: string, row: any): any => {
  let expr = expression
  
  originalFields.value.forEach(field => {
    const regex = new RegExp(`\\b${field.name}\\b`, 'g')
    const value = row[field.name]
    
    if (typeof value === 'string') {
      expr = expr.replace(regex, `"${value}"`)
    } else {
      expr = expr.replace(regex, String(value))
    }
  })
  
  try {
    return new Function('return ' + expr)()
  } catch (error) {
    throw new Error('Ë°®ËææÂºèÊâßË°åÂ§±Ë¥•')
  }
}

// ExcelÂ∑•ÂÖ∑Ê†èÊñπÊ≥ï
const toggleBold = () => {
  cellFormat.bold = !cellFormat.bold
  applyCurrentFormatToCell()
}

const toggleItalic = () => {
  cellFormat.italic = !cellFormat.italic
  applyCurrentFormatToCell()
}

const toggleUnderline = () => {
  cellFormat.underline = !cellFormat.underline
  applyCurrentFormatToCell()
}

const setBorderStyle = (style: 'all' | 'outer' | 'none') => {
  cellFormat.borderStyle = style
  applyCurrentFormatToCell()
}

const clearAll = () => {
  // Ê∏ÖÁ©∫ÊâÄÊúâÊï∞ÊçÆ
  Object.keys(renderedData).forEach(key => {
    delete renderedData[key]
  })
  ElMessage.success('Ë°®Ê†ºÂ∑≤Ê∏ÖÁ©∫')
}

const handleSave = async () => {
  saving.value = true
  try {
    // ‰øùÂ≠òÈÄªËæë
    await new Promise(resolve => setTimeout(resolve, 1000))
    ElMessage.success('Êä•Ë°®‰øùÂ≠òÊàêÂäü')
  } catch (error) {
    ElMessage.error('‰øùÂ≠òÂ§±Ë¥•')
  } finally {
    saving.value = false
  }
}

// ÁîüÂëΩÂë®Êúü
onMounted(async () => {
  console.log('üöÄ ExcelÊä•Ë°®ËÆæËÆ°Âô®ÂêØÂä®')
  
  // Âº∫Âà∂ÊòæÁ§∫Âè≥‰æßÈù¢Êùø
  rightPanelVisible.value = true
  
  // ÈªòËÆ§ÈÄâÊã©ÊúàÂ∫¶ÁªüËÆ°Êï∞ÊçÆÊ∫ê
  selectedDataSource.value = 'visit_stat_monthly'
  
  // Á´ãÂç≥Âä†ËΩΩÊ®°ÊãüÊï∞ÊçÆ
  loadMockData()
  console.log('‚úÖ Ê®°ÊãüÊï∞ÊçÆÂ∑≤Âä†ËΩΩ - Â≠óÊÆµÊï∞:', originalFields.value.length)
  
  // ÂºÇÊ≠•Â∞ùËØïÂä†ËΩΩÁúüÂÆûÊï∞ÊçÆÊ∫ê
  setTimeout(async () => {
    try {
      await loadAvailableDataSources()
      if (selectedDataSource.value && !originalFields.value.length) {
        await loadDataSource()
      }
    } catch (error) {
      console.log('‰ΩøÁî®Ê®°ÊãüÊï∞ÊçÆ‰Ωú‰∏∫ÈªòËÆ§Êï∞ÊçÆÊ∫ê')
    }
  }, 500)
  
  // ÂàùÂßãÂåñÊªöÂä®ÂêåÊ≠•
  if (cellsAreaRef.value && rowHeadersRef.value) {
    cellsAreaRef.value.addEventListener('scroll', () => {
      if (rowHeadersRef.value && cellsAreaRef.value) {
        rowHeadersRef.value.scrollTop = cellsAreaRef.value.scrollTop
      }
    })
  }
})

const dataFilter = ref('')
const filteredData = computed(() => {
  return sourceData.value.filter(row => {
    return Object.values(row).some(value => {
      return String(value).toLowerCase().includes(dataFilter.value.toLowerCase())
    })
  })
})

// Â∫îÁî®Êï∞ÊçÆËøáÊª§
const applyDataFilter = () => {
  // ËøôÈáåÂèØ‰ª•Ê∑ªÂä†Êõ¥Â§öÁöÑËøáÊª§ÈÄªËæë
  console.log('ËøáÊª§Êù°‰ª∂:', dataFilter.value)
}

// ÂçïÂÖÉÊ†ºÊãñÊãΩÂ§ÑÁêÜ
const handleCellDragOver = (event: DragEvent, rowIndex: number, col: string) => {
  event.preventDefault()
  if (filteredData.value.length === 1) {
    isDragOverColumn.value = col
  }
}

const handleCellDrop = (event: DragEvent, rowIndex: number, col: string) => {
  event.preventDefault()
  isDragOverColumn.value = null
  
  try {
    const dragData = event.dataTransfer?.getData('application/json')
    if (dragData) {
      const data = JSON.parse(dragData)
      
      // Â§ÑÁêÜÁªÑ‰ª∂ÊãñÊãΩ
      if (data.type === 'component') {
        const cellRef = `${col}${rowIndex}`
        handleComponentDrop(data, cellRef)
        return
      }
      
      // Â§ÑÁêÜÂ≠óÊÆµÊãñÊãΩÔºàÂéüÊúâÈÄªËæëÔºâ
      if (filteredData.value.length !== 1) {
        ElMessage.warning('Âè™ÊúâËøáÊª§Âà∞ÂçïÊù°Êï∞ÊçÆÊó∂ÊâçËÉΩÊãñÊãΩÂà∞ÂçïÂÖÉÊ†ºÔºåËØ∑‰ΩøÁî®ËøáÊª§ÂäüËÉΩ')
        return
      }
      
      const field = data as FieldInfo
      
      // Ëé∑ÂèñÂçïÊù°Êï∞ÊçÆÁöÑÂ≠óÊÆµÂÄº
      const singleRow = filteredData.value[0]
      const cellRef = `${col}${rowIndex}`
      const fieldValue = singleRow[field.name]
      
      // Áõ¥Êé•ËÆæÁΩÆÂçïÂÖÉÊ†ºÂÄº
      renderedData[cellRef] = String(fieldValue || '')
      
      ElMessage.success(`Â≠óÊÆµ "${field.label}" ÁöÑÂÄº "${fieldValue}" Â∑≤Â°´ÂÖ• ${cellRef} ÂçïÂÖÉÊ†º`)
    }
  } catch (error) {
    console.error('ÊãñÊãΩÂ§ÑÁêÜÂ§±Ë¥•:', error)
    ElMessage.error('ÊãñÊãΩÂ§ÑÁêÜÂ§±Ë¥•')
  }
}

// Â§ÑÁêÜÁªÑ‰ª∂ÊãñÊãΩÂà∞ÂçïÂÖÉÊ†º
const handleComponentDrop = (componentData: any, cellRef: string) => {
  const { componentType, componentName } = componentData
  
  switch (componentType) {
    case 'text':
      renderedData[cellRef] = 'ÊñáÊú¨ÂÜÖÂÆπ'
      break
    case 'table':
      renderedData[cellRef] = '[Ë°®Ê†º]'
      break
    case 'chart':
      renderedData[cellRef] = '[ÂõæË°®]'
      break
    case 'image':
      renderedData[cellRef] = '[ÂõæÁâá]'
      break
    default:
      renderedData[cellRef] = `[${componentName}]`
  }
  
  ElMessage.success(`ÁªÑ‰ª∂ "${componentName}" Â∑≤ÊèíÂÖ•Âà∞ ${cellRef} ÂçïÂÖÉÊ†º`)
}

const insertRowAbove = () => {
  // ÂÆûÁé∞ÊèíÂÖ•Ë°å‰∏äÊñπÁöÑÈÄªËæë
  contextMenu.visible = false
  ElMessage.success('Â∑≤Âú®‰∏äÊñπÊèíÂÖ•Ë°å')
}

const insertRowBelow = () => {
  // ÂÆûÁé∞ÊèíÂÖ•Ë°å‰∏ãÊñπÁöÑÈÄªËæë
  contextMenu.visible = false
  ElMessage.success('Â∑≤Âú®‰∏ãÊñπÊèíÂÖ•Ë°å')
}

const insertColumnLeft = () => {
  // ÂÆûÁé∞ÊèíÂÖ•ÂàóÂ∑¶‰æßÁöÑÈÄªËæë
  contextMenu.visible = false
  ElMessage.success('Â∑≤Âú®Â∑¶‰æßÊèíÂÖ•Âàó')
}

const insertColumnRight = () => {
  // ÂÆûÁé∞ÊèíÂÖ•ÂàóÂè≥‰æßÁöÑÈÄªËæë
  contextMenu.visible = false
  ElMessage.success('Â∑≤Âú®Âè≥‰æßÊèíÂÖ•Âàó')
}

const deleteRow = () => {
  // ÂÆûÁé∞Âà†Èô§Ë°åÁöÑÈÄªËæë
  const row = selectedCell.row
  allRows.value.forEach(r => {
    allColumns.value.forEach(col => {
      if (r === row) {
        delete renderedData[`${col}${r}`]
      }
    })
  })
  contextMenu.visible = false
  ElMessage.success(`Â∑≤Âà†Èô§Á¨¨ ${row} Ë°å`)
}

const deleteColumn = () => {
  // ÂÆûÁé∞Âà†Èô§ÂàóÁöÑÈÄªËæë
  const col = selectedCell.col
  allRows.value.forEach(row => {
    delete renderedData[`${col}${row}`]
  })
  delete columnFieldMap[col]
  contextMenu.visible = false
  ElMessage.success(`Â∑≤Âà†Èô§ ${col} Âàó`)
}

const formatCell = () => {
  // ‰ΩøÁî®ÂΩìÂâçÂçïÂÖÉÊ†ºÊ†ºÂºèÂàùÂßãÂåñÂØπËØùÊ°Ü
  formatDialog.form.fontFamily = currentFont.value
  formatDialog.form.fontSize = fontSize.value
  formatDialog.form.color = cellFormat.color
  formatDialog.form.backgroundColor = cellFormat.backgroundColor
  formatDialog.form.textAlign = cellFormat.textAlign
  formatDialog.form.bold = cellFormat.bold
  formatDialog.form.italic = cellFormat.italic
  formatDialog.form.underline = cellFormat.underline
  
  formatDialog.visible = true
  contextMenu.visible = false
}

const clearCell = () => {
  const cellKey = `${selectedCell.col}${selectedCell.row}`
  delete renderedData[cellKey]
  contextMenu.visible = false
  ElMessage.success('Â∑≤Ê∏ÖÈô§ÂçïÂÖÉÊ†ºÂÜÖÂÆπ')
}

// üìã ÂçïÂÖÉÊ†ºÂêàÂπ∂ÂäüËÉΩ
const mergeCells = () => {
  if (selectedCells.value.length < 2) {
    ElMessage.warning('ËØ∑ÈÄâÊã©Â§ö‰∏™ÂçïÂÖÉÊ†ºËøõË°åÂêàÂπ∂')
    return
  }
  
  // ËÆ°ÁÆóÂêàÂπ∂ËåÉÂõ¥
  const startCell = selectedCells.value[0]
  const endCell = selectedCells.value[selectedCells.value.length - 1]
  
  // ÂàõÂª∫ÂêàÂπ∂ÂçïÂÖÉÊ†ºËÆ∞ÂΩï
  const mergeKey = `${startCell.col}${startCell.row}`
  const rowspan = Math.abs(endCell.row - startCell.row) + 1
  const colspan = Math.abs(getColumnIndex(endCell.col) - getColumnIndex(startCell.col)) + 1
  
  mergedCells[mergeKey] = {
    rowspan,
    colspan,
    startRow: Math.min(startCell.row, endCell.row),
    startCol: startCell.col < endCell.col ? startCell.col : endCell.col,
    endRow: Math.max(startCell.row, endCell.row),
    endCol: startCell.col > endCell.col ? startCell.col : endCell.col
  }
  
  // ‰øùÁïôÁ¨¨‰∏Ä‰∏™ÂçïÂÖÉÊ†ºÁöÑÂÜÖÂÆπÔºåÊ∏ÖÁ©∫ÂÖ∂‰ªñÂçïÂÖÉÊ†º
  const firstCellKey = mergeKey
  const firstCellValue = renderedData[firstCellKey] || ''
  
  selectedCells.value.forEach((cell, index) => {
    const cellKey = `${cell.col}${cell.row}`
    if (index === 0) {
      // ‰øùÁïôÁ¨¨‰∏Ä‰∏™ÂçïÂÖÉÊ†ºÁöÑÂÜÖÂÆπ
      renderedData[cellKey] = firstCellValue
    } else {
      // Ê∏ÖÁ©∫ÂÖ∂‰ªñÂçïÂÖÉÊ†º
      delete renderedData[cellKey]
    }
  })
  
  clearSelection()
  ElMessage.success(`Â∑≤ÂêàÂπ∂ ${rowspan}x${colspan} ÂçïÂÖÉÊ†º`)
}

// ÊãÜÂàÜÂçïÂÖÉÊ†º
const splitCells = () => {
  const cellKey = `${selectedCell.col}${selectedCell.row}`
  
  if (mergedCells[cellKey]) {
    delete mergedCells[cellKey]
    ElMessage.success('Â∑≤ÊãÜÂàÜÂçïÂÖÉÊ†º')
  } else {
    ElMessage.warning('ÂΩìÂâçÂçïÂÖÉÊ†ºÊú™ÂêàÂπ∂')
  }
  contextMenu.visible = false
}

// Ëé∑Âèñ‰∏ã‰∏ÄÂàó
const getNextColumn = (col: string): string => {
  const index = allColumns.value.findIndex(c => c === col)
  return allColumns.value[index + 1] || col
}

// Ëé∑ÂèñÂàóÁ¥¢Âºï
const getColumnIndex = (col: string): number => {
  return allColumns.value.findIndex(c => c === col)
}

const handleCellDragEnter = (event: DragEvent, rowIndex: number, col: string) => {
  event.preventDefault()
  if (filteredData.value.length === 1) {
    isDragOverColumn.value = col
  }
}

const handleCellDragLeave = (event: DragEvent, rowIndex: number, col: string) => {
  const rect = (event.currentTarget as HTMLElement).getBoundingClientRect()
  const x = event.clientX
  const y = event.clientY
  
  if (x < rect.left || x > rect.right || y < rect.top || y > rect.bottom) {
    isDragOverColumn.value = null
  }
}

const isCellDropReady = (rowIndex: number, col: string): boolean => {
  return isDragOverColumn.value === col && filteredData.value.length === 1
}

const contextMenu = reactive({
  visible: false,
  x: 0,
  y: 0
})

// Ââ™Ë¥¥ÊùøÊï∞ÊçÆ
const clipboard = reactive({
  hasData: false,
  data: [] as any[],
  type: 'single' as 'single' | 'range'
})

const formatDialog = reactive({
  visible: false,
  form: {
    fontFamily: 'Microsoft YaHei',
    fontSize: 12,
    color: '#000000',
    backgroundColor: '#ffffff',
    textAlign: 'left',
    bold: false,
    italic: false,
    underline: false
  }
})

const applyFormat = () => {
  formatDialog.visible = false
  // Â∫îÁî®Ê†ºÂºèËÆæÁΩÆ
  cellFormat.color = formatDialog.form.color
  cellFormat.backgroundColor = formatDialog.form.backgroundColor
  cellFormat.bold = formatDialog.form.bold
  cellFormat.italic = formatDialog.form.italic
  cellFormat.underline = formatDialog.form.underline
  cellFormat.textAlign = formatDialog.form.textAlign as 'left' | 'center' | 'right'
}

const copyCell = () => {
  const cellKey = `${selectedCell.col}${selectedCell.row}`
  const cellValue = renderedData[cellKey] || ''
  clipboard.hasData = true
  // ËøôÈáåÂèØ‰ª•‰ΩøÁî®navigator.clipboard.writeText(cellValue)
  contextMenu.visible = false
  ElMessage.success('Â∑≤Â§çÂà∂ÂçïÂÖÉÊ†ºÂÜÖÂÆπ')
}

const pasteCell = () => {
  if (!clipboard.hasData) return
  // ËøôÈáåÂèØ‰ª•‰ΩøÁî®navigator.clipboard.readText()Êù•Á≤òË¥¥
  const cellKey = `${selectedCell.col}${selectedCell.row}`
  renderedData[cellKey] = 'Á≤òË¥¥ÁöÑÂÜÖÂÆπ' // Á§∫‰æã
  contextMenu.visible = false
  ElMessage.success('Â∑≤Á≤òË¥¥Âà∞ÂçïÂÖÉÊ†º')
}

// Âè≥ÈîÆËèúÂçïÂ§ÑÁêÜ
const handleCellRightClick = (event: MouseEvent, row: number, col: string) => {
  event.preventDefault()
  
  // Â¶ÇÊûúÁÇπÂáªÁöÑÂçïÂÖÉÊ†º‰∏çÂú®ÂΩìÂâçÈÄâÊã©ËåÉÂõ¥ÂÜÖÔºåÈÄâÊã©ËØ•ÂçïÂÖÉÊ†º
  if (!isCellInSelection(row, col)) {
    selectCell(row, col) // ÂÜÖÈÉ®Ë∞ÉÁî®Ôºå‰∏çÈúÄË¶ÅeventÂèÇÊï∞
  }
  
  contextMenu.x = event.clientX
  contextMenu.y = event.clientY
  contextMenu.visible = true
  
  // ÁÇπÂáªÂÖ∂‰ªñÂú∞ÊñπÈöêËóèËèúÂçï
  const hideMenu = () => {
    contextMenu.visible = false
    document.removeEventListener('click', hideMenu)
  }
  setTimeout(() => {
    document.addEventListener('click', hideMenu)
  }, 0)
}

// ÁªÑ‰ª∂ÊãñÊãΩÂ§ÑÁêÜ
const handleComponentDragStart = (event: DragEvent, component: any) => {
  if (event.dataTransfer) {
    event.dataTransfer.setData('component', JSON.stringify(component))
  }
}

// Âú®ÂΩìÂâçÈÄâ‰∏≠ÂçïÂÖÉÊ†ºÊèíÂÖ•ÁªÑ‰ª∂
const insertComponentAtCursor = (component: any) => {
  const cellKey = `${selectedCell.col}${selectedCell.row}`
  renderedData[cellKey] = `[${component.name}]`
  ElMessage.success(`Â∑≤ÊèíÂÖ•${component.name}ÁªÑ‰ª∂`)
}

// Ê†ºÂºèÂåñÂçïÂÖÉÊ†ºÂÄº
const formatCellValue = (value: string): string => {
  // Êï∞Â≠óÊ£ÄÊµã
  if (!isNaN(Number(value)) && value.trim() !== '') {
    const num = Number(value)
    // Â¶ÇÊûúÊòØÊï¥Êï∞Ôºå‰∏çÊòæÁ§∫Â∞èÊï∞ÁÇπ
    if (Number.isInteger(num)) {
      return num.toLocaleString()
    } else {
      return num.toFixed(2)
    }
  }
  
  // Êó•ÊúüÊ£ÄÊµã
  const date = new Date(value)
  if (!isNaN(date.getTime()) && (value.includes('-') || value.includes('/'))) {
    return date.toLocaleDateString('zh-CN')
  }
  
  // ÊôÆÈÄöÊñáÊú¨
  return value
}

// ÁÆÄÂçïË°®ËææÂºèËÆ°ÁÆóÂºïÊìé
const evaluateSimpleExpression = (expr: string): number => {
  // ÊõøÊç¢ÂçïÂÖÉÊ†ºÂºïÁî®‰∏∫ÂÆûÈôÖÂÄº
  let expression = expr.toUpperCase()
  
  // Â§ÑÁêÜÂçïÂÖÉÊ†ºÂºïÁî® (Â¶Ç A1, B2)
  const cellRefRegex = /([A-Z]+)(\d+)/g
  expression = expression.replace(cellRefRegex, (match, col, row) => {
    const cellValue = getCellValue(parseInt(row), col)
    const numValue = parseFloat(cellValue) || 0
    return numValue.toString()
  })
  
  // Â§ÑÁêÜÂü∫Êú¨Êï∞Â≠¶ËøêÁÆó
  try {
    // ÂÆâÂÖ®ÁöÑË°®ËææÂºèËÆ°ÁÆóÔºåÂè™ÂÖÅËÆ∏Êï∞Â≠óÂíåÂü∫Êú¨ËøêÁÆóÁ¨¶
    const safeExpr = expression.replace(/[^0-9+\-*/().\s]/g, '')
    return new Function('return ' + safeExpr)()
  } catch (error) {
    throw new Error('Êó†ÊïàÁöÑË°®ËææÂºè')
  }
}

// üîß ÂàóÂÆΩË°åÈ´òË∞ÉÊï¥ÂäüËÉΩ
const startResize = (event: MouseEvent, type: 'column' | 'row', target: string | number) => {
  event.preventDefault()
  event.stopPropagation()
  
  const currentSize = type === 'column' 
    ? columnWidths[target as string] || defaultColumnWidth
    : rowHeights[target as number] || defaultRowHeight
  
  resizing.value = {
    type,
    target,
    startX: event.clientX,
    startY: event.clientY,
    startSize: currentSize
  }
  
  // Ê∑ªÂä†ÂÖ®Â±ÄÈº†Ê†á‰∫ã‰ª∂ÁõëÂê¨
  document.addEventListener('mousemove', handleResize)
  document.addEventListener('mouseup', stopResize)
  
  // Ê∑ªÂä†ÊãñÊãΩÊ†∑Âºè
  document.body.style.cursor = type === 'column' ? 'col-resize' : 'row-resize'
  document.body.style.userSelect = 'none'
}

const handleResize = (event: MouseEvent) => {
  if (!resizing.value) return
  
  const { type, target, startX, startY, startSize } = resizing.value
  
  if (type === 'column') {
    const deltaX = event.clientX - startX
    const newWidth = Math.max(30, startSize + deltaX) // ÊúÄÂ∞èÂÆΩÂ∫¶30px
    columnWidths[target as string] = newWidth
  } else {
    const deltaY = event.clientY - startY
    const newHeight = Math.max(15, startSize + deltaY) // ÊúÄÂ∞èÈ´òÂ∫¶15px
    rowHeights[target as number] = newHeight
  }
}

const stopResize = () => {
  resizing.value = null
  document.removeEventListener('mousemove', handleResize)
  document.removeEventListener('mouseup', stopResize)
  
  // ÊÅ¢Â§çÊ†∑Âºè
  document.body.style.cursor = ''
  document.body.style.userSelect = ''
}

// Ëá™ÈÄÇÂ∫îÂàóÂÆΩ
const autoFitColumn = (col: string) => {
  // ËÆ°ÁÆóËØ•ÂàóÂÜÖÂÆπÁöÑÊúÄÂ§ßÂÆΩÂ∫¶
  let maxWidth = 60 // ÊúÄÂ∞èÂÆΩÂ∫¶
  
  allRows.value.forEach(row => {
    const cellValue = getCellValue(row, col)
    if (cellValue) {
      // ÁÆÄÂçï‰º∞ÁÆóÊñáÊú¨ÂÆΩÂ∫¶ (ÊØè‰∏™Â≠óÁ¨¶Á∫¶8px)
      const textWidth = cellValue.length * 8 + 20 // Âä†‰∏äpadding
      maxWidth = Math.max(maxWidth, textWidth)
    }
  })
  
  columnWidths[col] = Math.min(maxWidth, 300) // ÊúÄÂ§ßÂÆΩÂ∫¶300px
  ElMessage.success(`Âàó ${col} Â∑≤Ëá™ÈÄÇÂ∫îÂÆΩÂ∫¶`)
}

const canMerge = computed(() => {
  return selectedCells.value.length > 1
})

const canSplit = computed(() => {
  return selectedCells.value.length === 1
})

const selectAll = () => {
  selectionRange.start = { row: 1, col: 'A' }
  selectionRange.end = { row: allRows.value[allRows.value.length - 1], col: allColumns.value[allColumns.value.length - 1] }
  selectionRange.active = true
  ElMessage.success('Â∑≤ÂÖ®ÈÄâÊâÄÊúâÂçïÂÖÉÊ†º')
}

const clearSelection = () => {
  selectionRange.active = false
  selectedCell.row = 1
  selectedCell.col = 'A'
  selectedCell.ref = 'A1'
  ElMessage.success('Â∑≤Ê∏ÖÈô§ÈÄâÊã©')
}

const mergeSelectedCells = () => {
  // ËøôÈáåÈúÄË¶ÅÈÄâÊã©Âå∫ÂüüÔºåÂÖàÁî®ÂΩìÂâçÈÄâ‰∏≠ÂçïÂÖÉÊ†º‰Ωú‰∏∫Á§∫‰æã
  const startRow = Math.min(...selectedCells.value.map(cell => cell.row))
  const endRow = Math.max(...selectedCells.value.map(cell => cell.row))
  const startCol = selectedCells.value[0].col
  const endCol = selectedCells.value[selectedCells.value.length - 1].col
  
  const mergeKey = `${startCol}${startRow}`
  
  mergedCells[mergeKey] = {
    rowspan: endRow - startRow + 1,
    colspan: getColumnIndex(endCol) - getColumnIndex(startCol) + 1,
    startRow,
    startCol,
    endRow,
    endCol
  }
  
  contextMenu.visible = false
  ElMessage.success(`Â∑≤ÂêàÂπ∂ÂçïÂÖÉÊ†º ${startCol}${startRow}:${endCol}${endRow}`)
}

const splitSelectedCells = () => {
  const cellKey = `${selectedCell.col}${selectedCell.row}`
  
  if (mergedCells[cellKey]) {
    delete mergedCells[cellKey]
    ElMessage.success('Â∑≤ÊãÜÂàÜÂçïÂÖÉÊ†º')
  } else {
    ElMessage.warning('ÂΩìÂâçÂçïÂÖÉÊ†ºÊú™ÂêàÂπ∂')
  }
  contextMenu.visible = false
}

const setAlignment = (alignment: 'left' | 'center' | 'right') => {
  cellFormat.textAlign = alignment
  applyCurrentFormatToCell()
  ElMessage.success(`Â∑≤Â∫îÁî®${alignment}ÂØπÈΩêÊñπÂºè`)
}

// üñ±Ô∏è Èº†Ê†áÊãñÊãΩÈÄâÊã©ÂäüËÉΩ
const startCellSelection = (event: MouseEvent, row: number, col: string) => {
  // Â¶ÇÊûúÊåâ‰ΩèShiftÈîÆÔºåÊâ©Â±ïÁé∞ÊúâÈÄâÊã©
  if (event.shiftKey && selectionRange.active) {
    selectionRange.end = { row, col }
    return
  }
  
  // Âê¶ÂàôÂºÄÂßãÊñ∞ÁöÑÈÄâÊã©
  event.preventDefault()
  selectionRange.start = { row, col }
  selectionRange.end = { row, col }
  selectionRange.active = true
  selectionRange.selecting = true
  
  selectedCell.row = row
  selectedCell.col = col
  selectedCell.ref = `${col}${row}`
  
  // Ê∑ªÂä†ÂÖ®Â±Ä‰∫ã‰ª∂ÁõëÂê¨
  document.addEventListener('mouseup', endCellSelection)
  document.body.style.userSelect = 'none'
}

const handleCellMouseEnter = (event: MouseEvent, row: number, col: string) => {
  // Âè™Âú®ÊãñÊãΩÈÄâÊã©Êó∂ÊâçÂ§ÑÁêÜ
  if (!selectionRange.selecting) return
  
  selectionRange.end = { row, col }
}

const endCellSelection = () => {
  selectionRange.selecting = false
  document.removeEventListener('mouseup', endCellSelection)
  document.body.style.userSelect = ''
  
  // Â¶ÇÊûúÈÄâÊã©‰∫ÜËåÉÂõ¥ÔºåÊõ¥Êñ∞ÂÖ¨ÂºèÊ†èÊòæÁ§∫ËåÉÂõ¥‰ø°ÊÅØ
  if (selectedCells.value.length > 1) {
    const startCell = selectionRange.start
    const endCell = selectionRange.end
    cellFormula.value = `ËåÉÂõ¥: ${startCell.col}${startCell.row}:${endCell.col}${endCell.row} (${selectedCells.value.length} ‰∏™ÂçïÂÖÉÊ†º)`
  } else {
    // Âçï‰∏™ÂçïÂÖÉÊ†ºÔºåÊòæÁ§∫ÂÖ∂ÂÜÖÂÆπ
    const cellKey = `${selectionRange.start.col}${selectionRange.start.row}`
    cellFormula.value = renderedData[cellKey] || ''
  }
}

// Â∫îÁî®Ê†ºÂºèÂà∞ÈÄâ‰∏≠ÁöÑÂçïÂÖÉÊ†º
const applyFormatToSelectedCells = () => {
  const cells = selectedCells.value.length > 0 ? selectedCells.value : [{ row: selectedCell.row, col: selectedCell.col }]
  
  cells.forEach(cell => {
    const cellKey = `${cell.col}${cell.row}`
    if (!cellFormatMap[cellKey]) {
      cellFormatMap[cellKey] = {}
    }
    
    // Â∫îÁî®ÂΩìÂâçÊ†ºÂºèÂà∞ÂçïÂÖÉÊ†º
    Object.assign(cellFormatMap[cellKey], {
      fontFamily: currentFont.value,
      fontSize: fontSize.value,
      bold: cellFormat.bold,
      italic: cellFormat.italic,
      underline: cellFormat.underline,
      color: cellFormat.color,
      backgroundColor: cellFormat.backgroundColor,
      textAlign: cellFormat.textAlign
    })
  })
}

// ÁÆÄÂåñÁöÑÊ†ºÂºèÂ∫îÁî®ÂáΩÊï∞
const applyCurrentFormatToCell = () => {
  selectedCells.value.forEach(cell => {
    const cellKey = `${cell.col}${cell.row}`
    cellFormatMap[cellKey] = { ...cellFormat }
  })
}

// üéØ Êñ∞Â¢ûÂäüËÉΩÂÆûÁé∞

// ÊèíÂÖ•Ë°®Ê†ºÂäüËÉΩ
const showInsertTableDialog = () => {
  insertTableDialog.value = true
  // ÂàùÂßãÂåñË°®Ê†ºÊï∞ÊçÆ
  insertTableForm.data = Array(insertTableForm.rows).fill(null).map(() => 
    Array(insertTableForm.cols).fill('')
  )
}

const insertTable = () => {
  const startRow = selectedCell.row
  const startColIndex = getColumnIndex(selectedCell.col)
  
  // ÊèíÂÖ•Ë°®Ê†ºÊï∞ÊçÆÂà∞ÂçïÂÖÉÊ†º
  insertTableForm.data.forEach((row, rowIndex) => {
    row.forEach((cellValue, colIndex) => {
      const targetRow = startRow + rowIndex
      const targetCol = allColumns.value[startColIndex + colIndex]
      if (targetCol) {
        const cellKey = `${targetCol}${targetRow}`
        renderedData[cellKey] = cellValue
      }
    })
  })
  
  insertTableDialog.value = false
  ElMessage.success(`Â∑≤ÊèíÂÖ• ${insertTableForm.rows}x${insertTableForm.cols} Ë°®Ê†º`)
}

// ÁªëÂÆöÊï∞ÊçÆÈõÜÂà∞Ë°®Ê†º
const bindDatasetToTable = () => {
  if (sourceData.value.length === 0) {
    ElMessage.warning('ËØ∑ÂÖàÂä†ËΩΩÊï∞ÊçÆÊ∫ê')
    return
  }
  
  const startRow = selectedCell.row
  const startColIndex = getColumnIndex(selectedCell.col)
  
  // ÊèíÂÖ•Ë°®Â§¥
  if (insertTableForm.hasHeader) {
    originalFields.value.forEach((field, index) => {
      const targetCol = allColumns.value[startColIndex + index]
      if (targetCol) {
        const cellKey = `${targetCol}${startRow}`
        renderedData[cellKey] = field.label
      }
    })
  }
  
  // ÊèíÂÖ•Êï∞ÊçÆ
  const dataStartRow = insertTableForm.hasHeader ? startRow + 1 : startRow
  sourceData.value.slice(0, 10).forEach((rowData, rowIndex) => { // ÈôêÂà∂10Ë°åÊï∞ÊçÆ
    originalFields.value.forEach((field, colIndex) => {
      const targetCol = allColumns.value[startColIndex + colIndex]
      if (targetCol) {
        const cellKey = `${targetCol}${dataStartRow + rowIndex}`
        renderedData[cellKey] = String(rowData[field.name] || '')
      }
    })
  })
  
  insertTableDialog.value = false
  ElMessage.success('Êï∞ÊçÆÈõÜÂ∑≤ÁªëÂÆöÂà∞Ë°®Ê†º')
}

// ÂØºÂá∫ÂäüËÉΩ
const showExportDialog = () => {
  exportDialog.value = true
}

const exportReport = async () => {
  try {
    if (exportForm.format === 'xlsx') {
      await exportToExcel()
    } else if (exportForm.format === 'pdf') {
      await exportToPDF()
    }
    exportDialog.value = false
  } catch (error) {
    console.error('ÂØºÂá∫Â§±Ë¥•:', error)
    ElMessage.error('ÂØºÂá∫Â§±Ë¥•')
  }
}

const exportToExcel = async () => {
  // ‰ΩøÁî®Âä®ÊÄÅÂØºÂÖ•ÈÅøÂÖçÊâìÂåÖ‰ΩìÁßØËøáÂ§ß
  const XLSX = await import('xlsx')
  
  const worksheet = XLSX.utils.aoa_to_sheet([])
  const workbook = XLSX.utils.book_new()
  
  // Êî∂ÈõÜË¶ÅÂØºÂá∫ÁöÑÊï∞ÊçÆ
  const exportData: any[][] = []
  const maxRow = Math.max(...Object.keys(renderedData).map(key => {
    const match = key.match(/([A-Z]+)(\d+)/)
    return match ? parseInt(match[2]) : 0
  }))
  
  for (let row = 1; row <= maxRow; row++) {
    const rowData: any[] = []
    allColumns.value.forEach(col => {
      const cellKey = `${col}${row}`
      rowData.push(renderedData[cellKey] || '')
    })
    exportData.push(rowData)
  }
  
  const ws = XLSX.utils.aoa_to_sheet(exportData)
  XLSX.utils.book_append_sheet(workbook, ws, 'Êä•Ë°®')
  XLSX.writeFile(workbook, `${exportForm.filename}.xlsx`)
  
  ElMessage.success('ExcelÂØºÂá∫ÊàêÂäü')
}

const exportToPDF = async () => {
  // ‰ΩøÁî®html2canvasÂíåjsPDFËøõË°åPDFÂØºÂá∫
  const html2canvas = await import('html2canvas')
  const jsPDF = await import('jspdf')
  
  const canvas = await html2canvas.default(document.querySelector('.excel-table') as HTMLElement)
  const imgData = canvas.toDataURL('image/png')
  
  const pdf = new jsPDF.jsPDF()
  const imgWidth = 210
  const pageHeight = 295
  const imgHeight = (canvas.height * imgWidth) / canvas.width
  let heightLeft = imgHeight
  
  let position = 0
  
  pdf.addImage(imgData, 'PNG', 0, position, imgWidth, imgHeight)
  heightLeft -= pageHeight
  
  while (heightLeft >= 0) {
    position = heightLeft - imgHeight
    pdf.addPage()
    pdf.addImage(imgData, 'PNG', 0, position, imgWidth, imgHeight)
    heightLeft -= pageHeight
  }
  
  pdf.save(`${exportForm.filename}.pdf`)
  ElMessage.success('PDFÂØºÂá∫ÊàêÂäü')
}

// Â§çÂà∂ÈÄâÊã©ËåÉÂõ¥
const copySelection = () => {
  const data = selectedCells.value.map(cell => {
    const cellKey = `${cell.col}${cell.row}`
    return renderedData[cellKey] || ''
  })
  
  // ‰øùÂ≠òÂà∞Ââ™Ë¥¥ÊùøÊï∞ÊçÆ
  clipboard.data = data
  clipboard.hasData = true
  clipboard.type = 'range'
  
  ElMessage.success(`Â∑≤Â§çÂà∂ ${selectedCells.value.length} ‰∏™ÂçïÂÖÉÊ†º`)
}

// Âà†Èô§ÈÄâÊã©ËåÉÂõ¥
const deleteSelection = () => {
  selectedCells.value.forEach(cell => {
    const cellKey = `${cell.col}${cell.row}`
    delete renderedData[cellKey]
  })
  
  ElMessage.success(`Â∑≤Âà†Èô§ ${selectedCells.value.length} ‰∏™ÂçïÂÖÉÊ†ºÂÜÖÂÆπ`)
}

// Ê£ÄÊü•ÂçïÂÖÉÊ†ºÊòØÂê¶Ë¢´ÂêàÂπ∂
const isCellMerged = (row: number, col: string): boolean => {
  return Object.values(mergedCells).some(merge => {
    const colIndex = getColumnIndex(col)
    const startColIndex = getColumnIndex(merge.startCol)
    const endColIndex = getColumnIndex(merge.endCol)
    
    return row >= merge.startRow && 
           row <= merge.endRow && 
           colIndex >= startColIndex && 
           colIndex <= endColIndex &&
           !(row === merge.startRow && col === merge.startCol) // ‰∏çÊòØËµ∑ÂßãÂçïÂÖÉÊ†º
  })
}

// Ëé∑ÂèñÂêàÂπ∂ÂçïÂÖÉÊ†º‰ø°ÊÅØ
const getMergedCellInfo = (row: number, col: string) => {
  const cellKey = `${col}${row}`
  return mergedCells[cellKey]
}
</script>

<style scoped lang="scss">
// Excel‰∏ªÈ¢òËâ≤ÂΩ©
$excel-green: #107c41;
$excel-dark-green: #0e6b37;
$excel-light-gray: #f8f9fa;
$excel-border-color: #d1d5db;
$excel-selected-blue: #0078d4;
$excel-header-bg: #f3f4f6;
$excel-toolbar-bg: #f7f7f7;

.report-designer {
  height: 100vh;
  display: flex;
  flex-direction: column;
  background: white;
  font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
}

// È°∂ÈÉ®Â∑•ÂÖ∑Ê†è - ExcelÈ£éÊ†º
.designer-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 8px 16px;
  background: $excel-green;
  color: white;
  box-shadow: 0 2px 4px rgba(0,0,0,0.1);
  z-index: 20;

  .header-left {
  display: flex;
    align-items: center;
    gap: 16px;

    .report-title {
      font-size: 16px;
      font-weight: 600;
      color: white;
    }
  }

  .excel-btn {
    background: rgba(255,255,255,0.1);
    border: 1px solid rgba(255,255,255,0.2);
    color: white;
    
    &:hover {
      background: rgba(255,255,255,0.2);
      border-color: rgba(255,255,255,0.3);
    }
    
    &.el-button--success {
      background: rgba(34, 197, 94, 0.8);
      border-color: rgba(34, 197, 94, 0.9);
    }
    
    &.el-button--primary {
      background: rgba(59, 130, 246, 0.8);
      border-color: rgba(59, 130, 246, 0.9);
    }
  }
}

// ExcelÂ∑•ÂÖ∑Ê†èÁªÑ
.excel-toolbars {
  background: $excel-toolbar-bg;
  border-bottom: 2px solid $excel-border-color;
  box-shadow: 0 2px 8px rgba(0,0,0,0.1);
  z-index: 15;
}

// ‰∏ªÂ∑•ÂÖ∑Ê†è
.main-toolbar {
  padding: 8px 16px;

.toolbar-group {
  display: flex;
  align-items: center;
    gap: 16px;
    flex-wrap: wrap;
  }

  .toolbar-section {
    display: flex;
    align-items: center;
    gap: 6px;

    label {
      font-size: 12px;
      color: #374151;
      font-weight: 500;
    }
    
    .section-label {
      font-size: 11px;
      color: #6b7280;
      font-weight: 600;
      margin-right: 8px;
      white-space: nowrap;
    }
  }
  
  /* Â∑•ÂÖ∑Ê†èÁªÑ‰ª∂Âå∫Âüü */
  .components-toolbar {
    .toolbar-components {
      display: flex;
      gap: 4px;
      align-items: center;
    }
    
    .toolbar-component-item {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 6px 8px;
      background: white;
      border: 1px solid $excel-border-color;
      border-radius: 4px;
      cursor: pointer;
      transition: all 0.2s;
      min-width: 50px;
      height: 50px;
      user-select: none;
      position: relative;
      
      &:hover {
        background: #e5f3ff;
        border-color: $excel-selected-blue;
        transform: translateY(-1px);
        box-shadow: 0 2px 6px rgba(0, 120, 212, 0.2);
      }
      
      &:active {
        transform: translateY(0);
        box-shadow: 0 1px 3px rgba(0, 120, 212, 0.3);
      }
      
      .el-icon {
        font-size: 18px;
        color: $excel-selected-blue;
        margin-bottom: 2px;
      }
      
      span {
        font-size: 9px;
        color: #374151;
        font-weight: 500;
        line-height: 1;
        text-align: center;
      }
      
      /* ÊãñÊãΩÊó∂ÁöÑÊ†∑Âºè */
      &[draggable="true"] {
        cursor: grab;
        
        &:active {
          cursor: grabbing;
        }
      }
      
      /* Ê∑ªÂä†ÊãñÊãΩÊèêÁ§∫ */
      &::after {
        content: '';
        position: absolute;
        top: 2px;
        right: 2px;
        width: 6px;
        height: 6px;
        background: #10b981;
        border-radius: 50%;
        opacity: 0;
        transition: opacity 0.2s;
      }
      
      &:hover::after {
        opacity: 1;
      }
    }
  }

  .toolbar-divider {
    width: 1px;
    height: 32px;
    background: $excel-border-color;
    margin: 0 8px;
  }

  .toolbar-btn, .format-btn, .border-btn, .align-btn {
    background: white;
    border: 1px solid $excel-border-color;
    color: #374151;
    font-weight: 500;
    min-width: 32px;
    height: 32px;
    
    &:hover {
      background: #e5f3ff;
      border-color: $excel-selected-blue;
      color: $excel-selected-blue;
    }
    
    &.is-active {
      background: $excel-selected-blue;
      border-color: $excel-selected-blue;
      color: white;
    }
  }

  .render-btn {
    background: $excel-green;
    border-color: $excel-green;
    color: white;
    font-weight: 600;
    padding: 0 16px;
    
    &:hover {
      background: $excel-dark-green;
      border-color: $excel-dark-green;
    }
  }

  .excel-select {
    :deep(.el-input__wrapper) {
      border: 1px solid $excel-border-color;
      border-radius: 4px;
      
      &:hover {
        border-color: $excel-selected-blue;
      }
    }
  }

  .color-picker {
    :deep(.el-color-picker__trigger) {
      border: 1px solid $excel-border-color;
      border-radius: 4px;
      width: 32px;
      height: 32px;
    }
  }
}

// ÂÖ¨ÂºèÊ†è
.formula-bar {
  display: flex;
  align-items: center;
  background: white;
  border-bottom: 1px solid $excel-border-color;
  padding: 4px 8px;
  height: 32px;
  
  .name-box {
    width: 80px;
    margin-right: 8px;
    
    .name-input {
      width: 100%;
      height: 24px;
      border: 1px solid $excel-border-color;
      border-radius: 3px;
      padding: 0 6px;
      font-size: 12px;
      background: white;
      text-align: center;
      font-weight: 600;
      
      &:focus {
        outline: none;
        border-color: $excel-selected-blue;
        box-shadow: 0 0 0 1px rgba(0, 120, 212, 0.2);
      }
    }
  }
  
  .fx-label {
    width: 24px;
    height: 24px;
    background: $excel-light-gray;
    border: 1px solid $excel-border-color;
    border-radius: 3px 0 0 3px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 12px;
    font-weight: 600;
    color: #666;
  }
  
  .formula-input-container {
    flex: 1;
    display: flex;
    align-items: center;
    position: relative;
    
    .formula-input {
      flex: 1;
      height: 24px;
      border: 1px solid $excel-border-color;
      border-left: none;
      border-radius: 0;
      padding: 0 8px;
      font-size: 12px;
      font-family: 'Consolas', 'Monaco', monospace;
      
      &:focus {
        outline: none;
        border-color: $excel-selected-blue;
        box-shadow: 0 0 0 1px rgba(0, 120, 212, 0.2);
      }
      
      &.formula-drag-over {
        border-color: #f59e0b;
        background: #fef3c7;
        box-shadow: 0 0 0 1px rgba(245, 158, 11, 0.5);
      }
      
      &::placeholder {
        color: #9ca3af;
        font-style: italic;
      }
    }
    
    .apply-formula-btn {
      height: 24px;
      margin-left: 8px;
      border-radius: 0 3px 3px 0;
      padding: 0 12px;
      font-size: 11px;
      background: $excel-green;
      border-color: $excel-green;
      
      &:hover {
        background: $excel-dark-green;
        border-color: $excel-dark-green;
      }
    }
  }
  
  .formula-help {
    position: absolute;
    top: 100%;
    left: 0;
    right: 0;
    background: #f8fafc;
    border: 1px solid $excel-border-color;
    border-top: none;
  padding: 4px 8px;
    font-size: 11px;
    color: #6b7280;
    z-index: 10;
    
    .formula-preview {
      color: $excel-green;
      font-weight: 600;
    }
  }
}

// ‰∏ª‰ΩìÂå∫Âüü
.designer-body {
  flex: 1;
  display: flex;
  background: white;
  overflow: hidden;
}

// ‰∏≠Â§ÆExcelÂå∫Âüü
.table-container {
  flex: 1;
  display: flex;
  flex-direction: column;
  background: white;
  position: relative;
  transition: all 0.3s ease;
  
  &.panel-collapsed {
    margin-right: 0;
    width: 100%; // Á°Æ‰øùÊäòÂè†Êó∂Âç†Êª°ÂÖ®ÂÆΩ
  }
}

// ExcelË°®Ê†ºÂåÖË£ÖÂô®
.excel-table-wrapper {
  flex: 1;
  overflow: hidden;
  background: white;
  border: 2px solid $excel-border-color;
  border-radius: 0;
  position: relative;
}

// ÂàóÊ†áÈ¢ò - ÁúüÊ≠£ExcelÈ£éÊ†º
.column-headers {
  display: flex;
  position: sticky;
  top: 0;
  z-index: 10;
  background: $excel-header-bg;
  border-bottom: 2px solid $excel-border-color;

  .corner-cell {
    width: 50px;
    height: 21px;
    border-right: 1px solid $excel-border-color;
    background: $excel-header-bg;
    position: sticky;
    left: 0;
    z-index: 12;
}

.column-header {
    width: 80px;
    min-width: 80px;
    height: 21px;
    border-right: 1px solid $excel-border-color;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 11px;
    font-weight: 600;
    background: $excel-header-bg;
    color: #374151;
    user-select: none;
    cursor: pointer;
    position: relative;
    
    &:hover {
      background: #e5f3ff;
    }
    
    &.selected {
      background: #e3f2fd !important;
      border: 2px solid $excel-selected-blue !important;
      position: relative;
      z-index: 5;
    }
    
    // üéØ ÈÄâÊã©ËåÉÂõ¥Ê†∑Âºè
    &.in-selection {
      background: rgba(64, 158, 255, 0.1) !important;
      border: 1px solid rgba(64, 158, 255, 0.3) !important;
    }
    
    &.selection-start {
      border-top-left-radius: 4px;
      border: 2px solid #1976d2 !important;
    }
    
    &.selection-end {
      border-bottom-right-radius: 4px;
      border: 2px solid #1976d2 !important;
    }
    
    // ÂêàÂπ∂ÂçïÂÖÉÊ†ºÊ†∑Âºè
    &.merged-cell {
      background: #f3e5f5;
      border: 2px solid #9c27b0;
      
      &::after {
        content: '‚äû';
        position: absolute;
        top: 2px;
        right: 2px;
        font-size: 8px;
        color: #9c27b0;
        opacity: 0.7;
      }
    }
    
    .resize-handle {
      position: absolute;
      background: transparent;
      z-index: 10;
      
      &.resize-handle-col {
        top: 0;
        right: 0;
        width: 4px;
        height: 100%;
        cursor: col-resize;
        
        &:hover {
          background: rgba(64, 158, 255, 0.5);
        }
      }
      
      &.resize-handle-row {
        bottom: 0;
        left: 0;
        width: 100%;
        height: 4px;
        cursor: row-resize;
        
        &:hover {
          background: rgba(64, 158, 255, 0.5);
        }
      }
    }
  }
}

@keyframes pulse {
  0%, 100% {
    opacity: 1;
  }
  50% {
    opacity: 0.7;
  }
}

.spreadsheet-body {
  display: flex;
  height: calc(100vh - 200px);
  overflow: auto;
}

// Ë°åÊ†áÈ¢ò - ÁúüÊ≠£ExcelÈ£éÊ†º
.row-headers {
  position: sticky;
  left: 0;
  z-index: 5;
  background: $excel-header-bg;
  overflow-y: hidden;
  scrollbar-width: none;
  -ms-overflow-style: none;
  height: calc(100vh - 200px);
  
  &::-webkit-scrollbar {
    display: none;
}

.row-header {
    width: 50px;
    height: 21px;
    border-right: 1px solid $excel-border-color;
    border-bottom: 1px solid $excel-border-color;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 11px;
    font-weight: 600;
    background: $excel-header-bg;
    color: #374151;
    user-select: none;
    cursor: pointer;
    
    &:hover {
      background: #e5f3ff;
    }
    
    &.selected {
      background: $excel-selected-blue;
      color: white;
    }
  }
}

// ÂçïÂÖÉÊ†ºÂå∫Âüü
.cells-area {
  flex: 1;
  overflow: auto;
  position: relative;
}

// ExcelË°®Ê†º - ÂÆåÂÖ®ExcelÈ£éÊ†º
.excel-table {
  border-collapse: separate;
  border-spacing: 0;
  table-layout: fixed;
  width: 4000px; // Ë∂≥Â§üÂÆΩ‰ª•ÂÆπÁ∫≥50Âàó
  height: 2100px; // Ë∂≥Â§üÈ´ò‰ª•ÂÆπÁ∫≥100Ë°å

  td {
    height: 21px;
    border-right: 1px solid #c0c0c0;
    border-bottom: 1px solid #c0c0c0;
    padding: 0;
    position: relative;
    background: white;
    // ÁßªÈô§Âõ∫ÂÆöÂÆΩÂ∫¶ÔºåËÆ©getCellStyle‰∏≠ÁöÑwidthÊ†∑ÂºèÁîüÊïà
    box-sizing: border-box;

    &:hover {
      background: #f8fafc;
    }

    &.selected {
      background: #cce7ff;
      border: 2px solid $excel-selected-blue !important;
      z-index: 3;
      box-shadow: 0 0 0 1px $excel-selected-blue;
    }
    
    // üéØ ÈÄâÊã©ËåÉÂõ¥Ê†∑Âºè - ‰∏éÂàóÊ†áÈ¢ò‰øùÊåÅ‰∏ÄËá¥
    &.in-selection {
      background: rgba(64, 158, 255, 0.1) !important;
      border: 1px solid rgba(64, 158, 255, 0.3) !important;
    }
    
    &.selection-start {
      border-top-left-radius: 4px;
      border: 2px solid #1976d2 !important;
    }
    
    &.selection-end {
      border-bottom-right-radius: 4px;
      border: 2px solid #1976d2 !important;
    }
    
    // ÂêàÂπ∂ÂçïÂÖÉÊ†ºÊ†∑Âºè
    &.merged-cell {
      background: #f3e5f5;
      border: 2px solid #9c27b0;
      
      &::after {
        content: '‚äû';
        position: absolute;
        top: 2px;
        right: 2px;
        font-size: 8px;
        color: #9c27b0;
        opacity: 0.7;
      }
    }
  }
}

.cell-content {
  width: 100%;
  height: 100%;
  padding: 1px 4px;
  border: none;
  outline: none;
  font-size: 11px;
  line-height: 19px;
  overflow: hidden;
  white-space: nowrap;
  background: transparent;
  font-family: 'Calibri', 'Segoe UI', sans-serif;
  display: flex;
  align-items: center;
  color: #000;
  position: relative;
  
  &.drop-ready {
    background: #fef3c7 !important;
    border: 1px solid #f59e0b !important;
    
    .drop-hint {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      color: #92400e;
      font-size: 9px;
      font-weight: 600;
      white-space: nowrap;
      pointer-events: none;
    }
  }
}

.cell-input {
  width: 100%;
  height: 100%;
  padding: 1px 4px;
  border: 2px solid $excel-selected-blue;
  outline: none;
  font-size: 11px;
  line-height: 17px;
  background: white;
  font-family: 'Calibri', 'Segoe UI', sans-serif;
  color: #000;
  box-sizing: border-box;
  
  &:focus {
    border-color: $excel-selected-blue;
    box-shadow: 0 0 0 1px rgba(0, 120, 212, 0.2);
  }
}

// Âè≥‰æßÊï∞ÊçÆÊ∫êÈù¢Êùø
.fixed-right-panel {
  width: 300px;
  background: white;
  border-left: 2px solid $excel-border-color;
  overflow-y: auto;
  padding: 0;
  box-shadow: -2px 0 8px rgba(0,0,0,0.1);
  z-index: 1000;
  position: fixed;
  top: 0;
  right: 0;
  bottom: 0;
  transform: translateX(0);
  transition: transform 0.3s ease;
  box-sizing: border-box;

  &.panel-hidden {
    transform: translateX(100%);
  }

  .panel-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 16px 20px;
    background: $excel-green;
    color: white;
    border-bottom: 1px solid $excel-border-color;

    .panel-title {
      display: flex;
      align-items: center;
      gap: 8px;
      font-weight: 600;
      font-size: 16px;

      .el-icon {
        font-size: 18px;
      }
    }

    .close-btn {
      background: rgba(255,255,255,0.1);
      border: 1px solid rgba(255,255,255,0.2);
      color: white;
      
      &:hover {
        background: rgba(255,255,255,0.2);
        border-color: rgba(255,255,255,0.3);
      }
    }
  }

  .panel-content {
    padding: 20px;

    h4 {
      margin: 0 0 12px 0;
      color: #374151;
      font-weight: 600;
      font-size: 14px;
    }

    .data-source-selector {
      margin-bottom: 20px;
      
      .el-select {
        margin-bottom: 10px;
      }
    }

    .binding-status {
      margin-bottom: 20px;

      .binding-list {
        display: flex;
        flex-direction: column;
        gap: 8px;
      }

      .binding-item {
        display: flex;
        align-items: center;
        gap: 8px;
        padding: 8px 12px;
        background: #f8fafc;
        border: 1px solid #e5e7eb;
        border-radius: 4px;

        .col-name {
          font-weight: 600;
          color: #374151;
        }

        .arrow {
          color: #6b7280;
        }

        .field-name {
          flex: 1;
          color: #059669;
          font-weight: 500;
        }

        .remove-binding {
          color: #ef4444;
          
          &:hover {
            background: rgba(239, 68, 68, 0.1);
          }
        }
      }
    }

    .fields-section {
      margin-bottom: 20px;

      .fields-container {
        display: flex;
        flex-direction: column;
        gap: 8px;
        max-height: 250px;
        overflow-y: auto;
      }

      .field-card {
        display: flex;
        align-items: center;
        gap: 8px;
        padding: 10px 12px;
        background: #f0f9ff;
        border: 1px solid #0ea5e9;
        border-radius: 6px;
        cursor: move;
        transition: all 0.2s;

        &:hover {
          background: #e0f2fe;
          transform: translateY(-1px);
          box-shadow: 0 2px 8px rgba(14, 165, 233, 0.2);
        }

        .field-content {
          flex: 1;
          display: flex;
          flex-direction: column;
          gap: 2px;

          .field-name {
            font-size: 13px;
            color: #374151;
            font-weight: 500;
          }

          .field-type {
            font-size: 10px;
            color: #0ea5e9;
            font-weight: 600;
            text-transform: uppercase;
          }
        }

        .drag-handle {
          color: #0ea5e9;
          font-size: 16px;
        }
      }
    }

    .help-section {
      .help-card {
        padding: 16px;
        background: #fffbeb;
        border: 1px solid #fde68a;
        border-radius: 6px;

        h4 {
          margin-bottom: 12px;
          color: #92400e;
        }

        ol {
          list-style-type: decimal;
          padding-left: 20px;
          margin: 0;
          
          li {
            margin-bottom: 6px;
            font-size: 12px;
            color: #92400e;
            
            &:last-child {
              margin-bottom: 0;
            }
          }
        }
      }
      
      .formula-help-card {
        padding: 16px;
        background: #fffbeb;
        border: 1px solid #fde68a;
        border-radius: 6px;

        h4 {
          margin-bottom: 12px;
          color: #92400e;
        }

        .formula-examples {
          margin-bottom: 16px;

          p {
            margin-bottom: 8px;
            font-size: 12px;
            color: #92400e;
          }

          .formula-example {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 4px;

            code {
              background: #f3f4f6;
              padding: 4px 8px;
              border-radius: 4px;
            }

            .example-desc {
              font-size: 10px;
              color: #6b7280;
            }
          }
        }
      }
    }

    // üöÄ ‰∏ÄÈîÆÂÆåÊàêÂÖ∏ÂûãÂú∫ÊôØ
    .scenario-section {
      .scenario-card {
        padding: 16px;
        background: #fffbeb;
        border: 1px solid #fde68a;
        border-radius: 6px;

        h4 {
          margin-bottom: 12px;
          color: #92400e;
        }

        p {
          margin-bottom: 12px;
          font-size: 12px;
          color: #92400e;
        }

        .el-button {
          background: $excel-green;
          border-color: $excel-green;
          color: white;
          font-weight: 600;
          padding: 0 16px;
          
          &:hover {
            background: $excel-dark-green;
            border-color: $excel-dark-green;
          }
        }
      }
    }

    .data-preview-section {
      margin-bottom: 20px;

      .filter-controls {
        display: flex;
        flex-direction: column;
        gap: 8px;

        .filter-tips {
          display: flex;
          align-items: center;
          gap: 4px;
        }
      }

      .data-preview-table {
        margin-top: 8px;
        border: 1px solid #e5e7eb;
        border-radius: 6px;
        overflow: hidden;

        .mini-table {
          width: 100%;
          border-collapse: collapse;
          font-size: 11px;

          .mini-th {
            background: #f8fafc;
            padding: 6px 8px;
            border-bottom: 1px solid #e5e7eb;
            border-right: 1px solid #e5e7eb;
            font-weight: 600;
            color: #374151;
            text-align: left;
            font-size: 10px;
            
            &:last-child {
              border-right: none;
            }
          }

          .mini-td {
            padding: 6px 8px;
            border-bottom: 1px solid #f3f4f6;
            border-right: 1px solid #f3f4f6;
            color: #6b7280;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
            max-width: 80px;
            
            &:last-child {
              border-right: none;
            }
          }

          .mini-tr {
            &:hover {
              background: #f8fafc;
            }
            
            &:last-child .mini-td {
              border-bottom: none;
            }
          }
        }

        .more-data-hint {
          padding: 8px;
          background: #f8fafc;
          font-size: 11px;
          color: #6b7280;
          text-align: center;
          border-top: 1px solid #e5e7eb;
        }
      }
    }

    .drop-hint {
      color: #f59e0b;
      font-size: 10px;
      margin-top: 4px;
    }
  }
}

// ÊªöÂä®Êù°Ê†∑Âºè
:deep(.cells-area) {
  &::-webkit-scrollbar {
    width: 16px;
    height: 16px;
  }
  
  &::-webkit-scrollbar-track {
  background: #f1f1f1;
}

  &::-webkit-scrollbar-thumb {
  background: #c1c1c1;
    border-radius: 8px;

    &:hover {
  background: #a8a8a8;
    }
  }
  
  &::-webkit-scrollbar-corner {
    background: #f1f1f1;
  }
}

// ÂìçÂ∫îÂºèËÆæËÆ°
@media (max-width: 1200px) {
  .main-toolbar {
    .toolbar-group {
      gap: 8px;
    }
    
    .toolbar-divider {
      margin: 0 4px;
    }
  }
  
  .right-panel {
    width: 300px;
  }
}

.context-menu {
  position: fixed;
  background: white;
  border: 1px solid #e4e7ed;
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
  border-radius: 6px;
  padding: 4px 0;
  z-index: 2000;
  min-width: 160px;
  font-size: 13px;

  .menu-item {
    display: flex;
    align-items: center;
    padding: 8px 16px;
    cursor: pointer;
    transition: background 0.2s;
    color: #606266;

    &:hover {
      background: #f5f7fa;
      color: #409eff;
    }
    
    &.disabled {
      color: #c0c4cc;
      cursor: not-allowed;
      
      &:hover {
        background: transparent;
        color: #c0c4cc;
      }
    }

    .el-icon {
      margin-right: 8px;
      font-size: 14px;
    }
    
    span {
      flex: 1;
      white-space: nowrap;
    }
  }

  .menu-divider {
    height: 1px;
    background: #e4e7ed;
    margin: 4px 0;
  }
}

/* Â∑•ÂÖ∑Ê†èÊåâÈíÆÁªÑÊ†∑Âºè */
.cell-actions, .align-actions, .row-col-actions {
  .el-button {
    min-width: 32px;
    padding: 8px 6px;
    
    &:hover {
      background: #e3f2fd;
      border-color: $excel-selected-blue;
      color: $excel-selected-blue;
    }
    
    &:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
  }
}
.toolbar-section {
  .section-label {
    font-size: 10px;
    color: #6b7280;
    font-weight: 600;
    margin-right: 6px;
    white-space: nowrap;
    display: block;
    margin-bottom: 2px;
  }
}
</style> 

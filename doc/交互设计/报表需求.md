非常好，既然 **数据源已经抽象成数据集** ，那么接下来的重点就是：

> **如何实现“模板可视交互”，让业务用户通过网页端设计报表模板，完成字段绑定、格式配置、布局排版等全过程，而不需要写代码。**

---

## 一、什么是“模板可视交互”？

 **定义** ：

“模板可视交互”指的是用户通过 **拖拽、点选、配置等可视化操作** ，完成报表模板的设计和行为定义，而不是通过编写代码或脚本。

简而言之：

* 不是写 `{dataset.col}` 绑定字段，而是“拖字段到单元格”
* 不是写 `if else` 控制显示，而是“配置条件样式”
* 不是写 HTML，而是“所见即所得地排版布局”

---

## 二、模板可视交互核心功能模块（重点）

| 模块                  | 功能描述                                  | 举例说明                                                       |
| --------------------- | ----------------------------------------- | -------------------------------------------------------------- |
| 1. 拖拽式字段绑定     | 拖字段到单元格自动生成绑定                | 将“患者姓名”字段拖到A3，自动绑定 `${dataset.patient_name}` |
| 2. 单元格属性配置     | 配置字体、颜色、边框、合并等              | 设置A1加粗、红色、居中                                         |
| 3. 动态表达式配置     | 配置计算字段、条件显示等                  | `{amount} * {price}`或 “if 患者年龄>60 显示‘老年人’”     |
| 4. 分组与合计交互配置 | 指定某列作为分组字段，并显示小计/总计     | 按“科室”分组，统计每科室就诊人数                             |
| 5. 条件样式设置       | 基于数据设置样式变化                      | 金额 > 1000 显示红色字体                                       |
| 6. 参数化输入控件     | 模板中嵌入“选择框、日期框”等输入组件    | 在模板上方插入“时间范围选择”，驱动数据过滤                   |
| 7. 表格与组件布局     | 拖拽插入表格、文本、图表、图片等          | 拖一个“柱状图”展示按医生分布                                 |
| 8. 页眉页脚/分页控制  | 可视设置分页符、每页打印结构              | 设置每页顶部显示医院Logo与报表标题                             |
| 9. 模板预览与调试     | 设计后即时预览效果，显示字段绑定情况      | 实时渲染绑定数据、调试表达式错误                               |
| 10. 多模板管理        | 一个报表支持多个布局模板（移动端/打印版） | 同一数据集绑定不同模板，用于领导版和科室版报表                 |

---

## 三、典型可视交互设计流程（场景式）

### 🎯 目标：做一份“按科室统计每月就诊人数”的报表

#### 步骤 1：选择数据集

* 用户在左侧数据集区选中 `visit_stat_monthly`
* 展示字段树：`department_name`, `visit_month`, `visit_count`

#### 步骤 2：插入报表布局

* 拖入一个**表格**组件（5行 × 4列）
* A1 输入标题：`月度就诊统计`
* A2~C2 作为表头，输入：科室 | 月份 | 就诊人数

#### 步骤 3：字段绑定（拖拽）

* 将 `department_name` 拖到 A3
* 将 `visit_month` 拖到 B3
* 将 `visit_count` 拖到 C3

> 此时系统自动将这些绑定为 `${visit_stat_monthly.department_name}` 等

#### 步骤 4：设置分组与合计

* 指定“department_name”为分组字段
* 自动为每组添加小计：SUM(`visit_count`)
* 配置“总计行”显示在表底

#### 步骤 5：样式美化

* 设置标题行合并单元格、加粗、加边框
* 设置数字右对齐，列宽自适应
* 金额高于1000时字体变红（条件样式）

#### 步骤 6：添加参数控件

* 插入两个“日期选择器”
* 绑定到数据集查询参数：`start_date`, `end_date`

#### 步骤 7：预览与导出

* 点击“预览”：显示实际数据
* 确认无误后，导出为 PDF 或 Excel

---

## 四、实现建议（技术层面）

| 组件/模块      | 建议实现方式                                                  |
| -------------- | ------------------------------------------------------------- |
| 可视表格编辑器 | 自研/集成类 Excel Web 组件（如 Spreadsheet.js、Handsontable） |
| 字段拖拽绑定   | 拖动字段后自动插入绑定表达式 + 高亮标记                       |
| 样式配置面板   | 单元格右侧弹出样式配置 UI（字体、颜色、边框）                 |
| 分组与合计配置 | 类似数据透视表配置方式（拖拽字段至“分组区”、“汇总区”）    |
| 预览引擎       | 前端渲染绑定数据 / 后端动态填充模板生成                       |
| 模板保存格式   | 可保存为 JSON/XML/自定义DSL，含样式、绑定、逻辑结构等         |

---

## 五、总结

你当前已经完成了**数据源抽象为数据集**这一步，那么下一阶段就应聚焦在：

> 提供“**所见即所得** + **拖拽绑定** + **表达式配置** +  **样式排版** ”为一体的**模板可视交互系统**

这样能让业务用户零编程地构建强大的、数据驱动的报表模板。

---



非常好，这是一个**典型的“基于数据源的单元格交互计算赋值”场景**，你希望业务用户点击单元格 → 弹出交互 → 选择字段 → 配置计算 → 过滤参数 → 最终将计算结果写入单元格。

这个场景在低代码报表/数据建模系统中极具通用性。下面我将为你**流程化拆解**这个功能实现路径，帮助你在 `Univer + 数据源` 框架中进行系统集成。

---

## ✅ 目标功能一句话描述

> 用户点击某个单元格，触发“基于数据源的计算赋值”流程，通过交互配置过滤条件与计算逻辑，预览结果后将值写入该单元格。

---

## ✅ 一、整体流程图（高层抽象）

```
[单元格点击]
      ↓
[弹出配置面板]
      ↓
[选择数据源字段 → 配置过滤 + 函数]
      ↓
[预览结果（计算后的值）]
      ↓
[确认后将值写入当前单元格]
```

---

## ✅ 二、详细流程拆解（按功能模块）

| 步骤 | 功能点                             | 描述与说明                                                                                    |
| ---- | ---------------------------------- | --------------------------------------------------------------------------------------------- |
| ①   | **单元格点击事件监听**       | 在单元格右键菜单或点击按钮中添加“从数据源赋值”操作项，监听点击后触发                        |
| ②   | **弹出交互式对话框**         | 使用 Vue3 弹窗组件（如 `<el-dialog>`）弹出“数据赋值配置面板”                              |
| ③   | **数据源字段选择**           | 左侧加载用户可用的数据集字段列表（通过 API 请求）                                             |
| ④   | **配置过滤条件**             | 提供筛选器（字段 + 运算符 + 值），如 `age > 60`，支持多条件                                 |
| ⑤   | **选择计算函数**             | 支持内置函数（SUM, AVG, COUNT, MAX, MIN...）对筛选后的数据执行聚合                            |
| ⑥   | **预览计算结果**             | 动态请求数据源，显示计算结果及明细（如中间表）供用户验证                                      |
| ⑦   | **确认并写入单元格**         | 点击“确认”，将结果写入目标单元格，同时标记来源（例如：`calc_from_source(...)`）           |
| ⑧   | **记录数据绑定结构（可选）** | 可保存为 `${bind: { source: ..., field: ..., filter: ..., func: ... }}`，便于未来重算或导出 |

---

## ✅ 三、核心数据结构设计建议

### 1️⃣ 绑定结构（写入单元格时可用）

```json
{
  "bindType": "dataSourceComputed",
  "datasetId": "patient_visits",
  "filters": [
    { "field": "visit_date", "op": "between", "value": ["2024-01-01", "2024-12-31"] },
    { "field": "department", "op": "=", "value": "心内科" }
  ],
  "field": "visit_count",
  "aggregate": "SUM"
}
```

### 2️⃣ 前端 DSL → 后端 API 参数

```json
POST /api/dataset/compute

{
  "datasetId": "patient_visits",
  "filters": [...],
  "field": "visit_count",
  "aggregate": "SUM"
}
```

---

## ✅ 四、前端组件建议

| 组件名                     | 功能描述                                   |
| -------------------------- | ------------------------------------------ |
| `CellComputedDialog.vue` | 弹窗配置器组件（含字段选择、筛选器、预览） |
| `FieldSelector.vue`      | 字段列表面板，支持搜索、单选、多选         |
| `FilterConfigurator.vue` | 条件构造器，支持 =、>、<、in、between 等   |
| `PreviewTable.vue`       | 显示筛选后数据的预览表格                   |
| `FunctionSelector.vue`   | 函数选择器，下拉选择 SUM、AVG 等           |

---

## ✅ 五、后端接口需求

| 接口                     | 功能                                 |
| ------------------------ | ------------------------------------ |
| `/api/dataset/schema`  | 获取字段结构、字段类型               |
| `/api/dataset/preview` | 根据过滤条件返回预览明细数据（表格） |
| `/api/dataset/compute` | 根据过滤条件和计算函数返回结果值     |

---

## ✅ 六、拓展建议（增强实用性）

| 方向               | 描述                                               |
| ------------------ | -------------------------------------------------- |
| 🧠 绑定可更新      | 当数据源变更时，能重新计算所有绑定单元格           |
| 🔄 多单元格联动    | 一次操作可批量赋值多个单元格（如按维度铺展）       |
| 💾 模板绑定保存    | 报表模板中保存这些配置，便于复用或导出             |
| ✨ AI 推荐计算配置 | 自动识别用户可能要做的汇总字段与条件，推荐配置模板 |

---

## ✅ 七、可视化操作体验建议

| 操作           | 推荐 UI 交互                             |
| -------------- | ---------------------------------------- |
| 单元格操作菜单 | “右键菜单”中加入“从数据源计算赋值”   |
| 配置界面       | 类似 DataEase/Metabase 的计算构建器      |
| 表达式预览     | 在单元格中浮动提示当前绑定的计算逻辑     |
| 自动重算       | 数据源刷新时可手动或自动重算已绑定单元格 |

---

## ✅ 总结

你设计的“单元格点击 → 数据源计算赋值”的流程本质上是一个**低代码数据绑定 + 聚合计算配置器**，核心价值在于：

* 用户无需写 SQL，就能从多个维度对数据进行筛选与汇总；
* 单元格可以通过配置来表达业务含义，报表结构更清晰；
* 提高了业务人员配置报表的效率和灵活度。

---
